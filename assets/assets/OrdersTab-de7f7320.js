import{r as j,j as s,C as L,a as T,b as A,c as k,U as E,B as n,T as z,D as B,v as $,z as V,E as W,F as q,t as p}from"./index-1fdf2a9f.js";import{B as f}from"./badge-2a6a9d48.js";import{S as F,a as M,b as U,c as G,d as m}from"./select-48f71311.js";import{u as H}from"./useStoreDashboard-2973ddec.js";import{L as J}from"./index-9a5cc2f3.js";import{P as R}from"./package-061caa82.js";import{C as I}from"./clock-8d5c1bd5.js";import{T as K}from"./truck-2057356f.js";import{P as Q}from"./pencil-55ef72a4.js";import{M as X}from"./map-pin-082f2517.js";import"./check-b3577c63.js";import"./triangle-alert-320efe9f.js";const ds=({storeId:g})=>{var C;const{orders:u,fetchOrders:N,updateOrderStatus:w,isLoadingOrders:v,deleteOrder:D}=H(),[a,b]=j.useState(null),[P,x]=j.useState(!1),_=async e=>{if(window.confirm("¿Estás seguro de que deseas eliminar este pedido? Esta acción no se puede deshacer."))try{await D(e),p({title:"Pedido eliminado"}),(a==null?void 0:a.id)===e&&x(!1)}catch{p({title:"Error al eliminar",variant:"destructive"})}};j.useEffect(()=>{g&&N(g)},[g,N]);const h=async(e,t)=>{try{await w(e,t),p({title:"Estado Actualizado",description:`El pedido ahora está: ${t}`}),(a==null?void 0:a.id)===e&&b({...a,status:t})}catch{p({title:"Error",description:"No se pudo actualizar el estado.",variant:"destructive"})}},y=e=>{b(e),x(!0)},S=e=>{const t={Pendiente:"bg-yellow-100 text-yellow-800",Confirmado:"bg-blue-100 text-blue-800","En preparación":"bg-purple-100 text-purple-800","Listo para recogida":"bg-indigo-100 text-indigo-800","En curso":"bg-cyan-100 text-cyan-800",Entregado:"bg-green-100 text-green-800",Cancelado:"bg-red-100 text-red-800"};return s.jsx(f,{variant:"outline",className:`${t[e]||"bg-gray-100"} px-2 py-1`,children:e})};return v&&u.length===0?s.jsx(J,{text:"Cargando pedidos..."}):s.jsxs(L,{className:"animate-in fade-in duration-300",children:[s.jsxs(T,{className:"flex flex-row items-center justify-between",children:[s.jsx(A,{children:"Gestión de Pedidos"}),v&&s.jsx(f,{variant:"secondary",className:"animate-pulse",children:"Actualizando..."})]}),s.jsxs(k,{children:[u.length===0?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(R,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{children:"No tienes pedidos activos."})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"hidden md:grid grid-cols-12 gap-4 px-4 py-2 bg-slate-100 font-semibold text-sm text-slate-600 rounded-t-lg",children:[s.jsx("div",{className:"col-span-2",children:"ID Pedido"}),s.jsx("div",{className:"col-span-3",children:"Cliente"}),s.jsx("div",{className:"col-span-2",children:"Fecha"}),s.jsx("div",{className:"col-span-2",children:"Total / Items"}),s.jsx("div",{className:"col-span-3 text-center",children:"Estado / Acciones (v2)"})]}),u.map(e=>{var r,d,o;let t=((r=e.profiles)==null?void 0:r.full_name)||"Cliente Mostrador",l=((d=e.profiles)==null?void 0:d.phone)||"N/A";try{if(e.delivery_address&&(e.delivery_address.startsWith("{")||e.delivery_address.startsWith("["))){const i=JSON.parse(e.delivery_address);i.guest&&(t=i.guest.name||t,l=i.guest.phone||l)}}catch{}return s.jsxs("div",{className:"border rounded-lg p-3 grid grid-cols-1 md:grid-cols-12 gap-4 items-center bg-white hover:bg-slate-50 transition-colors shadow-sm",children:[s.jsxs("div",{className:"col-span-2 font-mono font-bold text-slate-700",children:["#",e.id.substring(0,8)]}),s.jsxs("div",{className:"col-span-3",children:[s.jsx("div",{className:"font-medium text-slate-900",children:t}),s.jsxs("div",{className:"text-xs text-slate-500 flex items-center gap-1",children:[s.jsx(E,{className:"h-3 w-3"})," ",l]})]}),s.jsxs("div",{className:"col-span-2 text-sm text-slate-600",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(I,{className:"h-3 w-3"})," ",new Date(e.created_at).toLocaleDateString()]}),s.jsx("div",{className:"text-xs text-gray-400",children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),s.jsxs("div",{className:"col-span-2",children:[s.jsxs("div",{className:"font-bold text-slate-800",children:["$",Number(e.total).toLocaleString()]}),s.jsxs("div",{className:"text-xs text-slate-500",children:[((o=e.order_items)==null?void 0:o.length)||0," ítems"]})]}),s.jsxs("div",{className:"col-span-3 flex flex-col gap-2 items-center justify-center",children:[S(e.status),s.jsx(n,{variant:"ghost",size:"sm",className:"h-6 text-xs text-blue-600 hover:text-blue-800",onClick:()=>y(e),children:"Ver Detalles"}),s.jsxs("div",{className:"flex gap-1 items-center",children:[["Pendiente","Pendiente de pago en efectivo"].includes(e.status)&&s.jsx(n,{size:"sm",className:"h-7 text-xs bg-blue-600 hover:bg-blue-700",onClick:()=>h(e.id,"Confirmado"),children:"Confirmar"}),e.status==="Confirmado"&&s.jsx(n,{size:"sm",className:"h-7 text-xs bg-purple-600 hover:bg-purple-700",onClick:()=>h(e.id,"En preparación"),children:"Preparar"}),e.status==="En preparación"&&s.jsxs(n,{size:"sm",className:"h-7 text-xs bg-indigo-600 hover:bg-indigo-700",onClick:()=>h(e.id,"Listo para recogida"),children:[s.jsx(K,{className:"h-3 w-3 mr-1"})," Listo"]}),s.jsxs(n,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs border-slate-300 bg-white",onClick:i=>{i.stopPropagation(),y(e)},children:[s.jsx(Q,{className:"h-3 w-3 mr-1"})," Edit"]}),s.jsxs(n,{size:"sm",variant:"destructive",className:"h-7 px-2 text-xs",onClick:i=>{i.stopPropagation(),_(e.id)},children:[s.jsx(z,{className:"h-3 w-3 mr-1"})," Del"]})]})]})]},e.id)})]}),s.jsx(B,{open:P,onOpenChange:x,children:s.jsxs($,{className:"max-w-2xl",children:[s.jsxs(V,{children:[s.jsxs(W,{children:["Pedido #",a==null?void 0:a.id.substring(0,8)]}),s.jsxs(q,{children:["Estado actual: ",s.jsx("span",{className:"font-semibold",children:a==null?void 0:a.status})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 py-4",children:[s.jsx("div",{children:(()=>{var o,i;let e=((o=a==null?void 0:a.profiles)==null?void 0:o.full_name)||"N/A",t=((i=a==null?void 0:a.profiles)==null?void 0:i.phone)||"N/A",l="N/A",r="N/A",d=!1;try{if(a!=null&&a.delivery_address&&(a.delivery_address.startsWith("{")||a.delivery_address.startsWith("["))){const c=JSON.parse(a.delivery_address);c.guest&&(d=!0,e=c.guest.name||e,t=c.guest.phone||t,l=c.guest.doc_id||"N/A",r=c.guest.email||"N/A")}}catch{}return s.jsxs(s.Fragment,{children:[s.jsxs("h4",{className:"font-semibold mb-2 flex items-center gap-2",children:[s.jsx(E,{className:"h-4 w-4"})," Datos del Cliente"]}),s.jsxs("div",{className:"space-y-1 text-sm text-slate-600",children:[s.jsxs("div",{className:"grid grid-cols-[80px_1fr]",children:[s.jsx("span",{className:"font-medium text-slate-800",children:"Nombre:"}),s.jsx("span",{children:e})]}),s.jsxs("div",{className:"grid grid-cols-[80px_1fr]",children:[s.jsx("span",{className:"font-medium text-slate-800",children:"Documento:"}),s.jsx("span",{children:l})]}),s.jsxs("div",{className:"grid grid-cols-[80px_1fr]",children:[s.jsx("span",{className:"font-medium text-slate-800",children:"Teléfono:"}),s.jsx("span",{children:t})]}),s.jsxs("div",{className:"grid grid-cols-[80px_1fr]",children:[s.jsx("span",{className:"font-medium text-slate-800",children:"Email:"}),s.jsx("span",{className:"truncate",title:r,children:r})]}),d&&s.jsx(f,{variant:"secondary",className:"mt-2 text-xs",children:"Venta POS / Invitado"})]})]})})()}),s.jsxs("div",{children:[s.jsxs("h4",{className:"font-semibold mb-2 flex items-center gap-2",children:[s.jsx(X,{className:"h-4 w-4"})," Detalle Entrega"]}),s.jsx("p",{className:"text-sm text-slate-600 bg-slate-50 p-2 rounded border",children:(()=>{var e;try{return(e=a==null?void 0:a.delivery_address)!=null&&e.includes('"guest":')?"Entrega inmediata en tienda (POS)":(a==null?void 0:a.delivery_address)||"Recogida en tienda"}catch{return(a==null?void 0:a.delivery_address)||"N/A"}})()})]})]}),s.jsxs("div",{className:"border-t pt-4",children:[s.jsx("h4",{className:"font-semibold mb-3",children:"Productos"}),s.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-2",children:(C=a==null?void 0:a.order_items)==null?void 0:C.map(e=>{var t;return s.jsxs("div",{className:"flex justify-between items-center text-sm p-3 border rounded-lg bg-slate-50",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs("div",{className:"font-mono bg-white px-2 py-1 rounded border text-xs font-bold",children:[e.quantity,"x"]}),s.jsx("span",{className:"font-medium text-slate-700",children:(t=e.products)==null?void 0:t.name})]}),s.jsxs("span",{className:"font-bold text-slate-800",children:["$",(e.price*e.quantity).toLocaleString()]})]},e.id)})}),s.jsxs("div",{className:"flex justify-between items-center mt-4 p-4 bg-slate-100 rounded-lg",children:[s.jsx("span",{className:"font-bold text-lg text-slate-700",children:"Total a Pagar"}),s.jsxs("span",{className:"font-bold text-2xl text-slate-900",children:["$",Number(a==null?void 0:a.total).toLocaleString()]})]})]}),s.jsxs("div",{className:"flex justify-end gap-2 border-t pt-4",children:[s.jsx(n,{variant:"outline",onClick:()=>x(!1),children:"Cerrar"}),(a==null?void 0:a.status)!=="Cancelado"&&(a==null?void 0:a.status)!=="Entregado"&&s.jsxs(F,{onValueChange:e=>h(a.id,e),children:[s.jsx(M,{className:"w-[180px]",children:s.jsx(U,{placeholder:"Cambiar Estado"})}),s.jsxs(G,{children:[s.jsx(m,{value:"Confirmado",children:"Confirmar"}),s.jsx(m,{value:"En preparación",children:"En preparación"}),s.jsx(m,{value:"Listo para recogida",children:"Listo para recogida"}),s.jsx(m,{value:"Entregado",children:"Entregado"}),s.jsx(m,{value:"Cancelado",children:"Cancelar Pedido"})]})]})]})]})})]})]})};export{ds as default};
