import{k as b,Q as A,r as h,j as e,B as v,P as I,D as O,v as F,z as B,E as R,f as U,C as V,c as z,T as $,t as q,g as G}from"./index-1fdf2a9f.js";import{L as H,B as J}from"./BaseStoreDashboard-4c707fc9.js";import Q from"./OverviewTab-9ca0347c.js";import{I as f}from"./input-6f32d436.js";import{S as K,a as W,b as X,c as Y,d as j}from"./select-48f71311.js";import{L as u}from"./label-dba26b4b.js";import{T as Z}from"./textarea-18eb8a34.js";import{S as ee}from"./switch-3609d52c.js";import{B as ae}from"./badge-2a6a9d48.js";import{u as re}from"./useStoreDashboard-2973ddec.js";import{P}from"./pill-f70e2c96.js";import{P as te}from"./pencil-55ef72a4.js";import se from"./OrdersTab-de7f7320.js";import ie from"./GenericPOSView-e6027ccd.js";import{B as oe}from"./BulkUploadTab-1b69a68f.js";import ne from"./FinancialsTab-778dcaf3.js";import ce from"./AdminTab-069434ad.js";import{S as le,a as de}from"./StoreCustomersTab-3bc4171b.js";import{C as me}from"./credit-card-6951c825.js";import{U as D}from"./users-f4b07dbb.js";import{U as pe}from"./upload-0f151953.js";import{D as ue,S as he}from"./settings-f7bf5df2.js";import"./Helmet-25af496a.js";import"./log-out-1c289f47.js";import"./index-9a5cc2f3.js";import"./triangle-alert-320efe9f.js";import"./package-061caa82.js";import"./trending-up-c46a6e61.js";import"./check-b3577c63.js";import"./index-3bb258d5.js";import"./clock-8d5c1bd5.js";import"./truck-2057356f.js";import"./map-pin-082f2517.js";import"./scroll-area-700d22f5.js";import"./shopping-cart-1d516b7d.js";import"./search-a003f046.js";import"./circle-check-big-1affdfe6.js";import"./circle-alert-2b8c34de.js";import"./user-plus-108fb48f.js";const y={_parseMetadata(r){var n;if(!r)return r;let c={expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""};const s=(n=r.description)==null?void 0:n.match(/PHARMA_META:\s*({.*})/s);let a=r.description||"";if(s)try{c={...c,...JSON.parse(s[1])},a=r.description.replace(/\n\nPHARMA_META:\s*{.*}/s,"")}catch{}return{...r,meta:c,description:a,full_description:r.description}},async getPharmacyProducts(r){const{data:c,error:s}=await b.from("products").select("*").eq("store_id",r).order("created_at",{ascending:!1});if(s)throw s;return c.map(this._parseMetadata)},async savePharmacyProduct(r){const{meta:c,description:s,...a}=r,n=JSON.stringify(c),t=`${s||""}

PHARMA_META: ${n}`,l={...a,description:t};if(l.id){const{data:x,error:d}=await b.from("products").update(l).eq("id",l.id).select().single();if(d)throw d;return this._parseMetadata(x)}else{const{data:x,error:d}=await b.from("products").insert(l).select().single();if(d)throw d;return this._parseMetadata(x)}},async deletePharmacyProduct(r){const{error:c}=await b.from("products").delete().eq("id",r);if(c)throw c},async createPOSTransaction({orderPayload:r,items:c}){const{data:s,error:a}=await b.from("orders").insert(r).select().single();if(a)throw a;const n=c.map(l=>({order_id:s.id,product_id:l.id,quantity:l.qty,price:l.price})),{error:t}=await b.from("order_items").insert(n);if(t)throw console.error("Error creating items",t),t;return s}},k=A((r,c)=>({products:[],cart:[],isLoadingCheckout:!1,addToCart:s=>{const a=c().cart,n=a.find(t=>t.id===s.id);if(n){if(n.qty>=s.stock)return!1;r({cart:a.map(t=>t.id===s.id?{...t,qty:t.qty+1}:t)})}else r({cart:[...a,{...s,qty:1}]});return!0},removeFromCart:s=>{r(a=>({cart:a.cart.filter(n=>n.id!==s)}))},updateCartQty:(s,a)=>{r(n=>({cart:n.cart.map(t=>{if(t.id===s){const l=Math.max(1,t.qty+a);return a>0&&l>t.stock?t:{...t,qty:l}}return t})}))},clearCart:()=>r({cart:[]}),processCheckout:async(s,a,n,t)=>{const l=c().cart;if(l.length===0)return;const x=typeof a=="object"?{name:a.name,doc_id:a.docId,phone:a.phone,email:a.email,method:n,type:"POS"}:{name:a,method:n,type:"POS"};r({isLoadingCheckout:!0});try{const d={store_id:s,customer_id:null,status:"Entregado",total:t,delivery_address:JSON.stringify({guest:x,items:l.map(p=>({id:p.id,name:p.name,qty:p.qty,price:p.price}))})};return await y.createPOSTransaction({orderPayload:d,items:l}),c().clearCart(),c().fetchProducts(s),!0}catch(d){throw d}finally{r({isLoadingCheckout:!1})}},isLoading:!1,error:null,fetchProducts:async s=>{r({isLoading:!0,error:null});try{const a=await y.getPharmacyProducts(s);r({products:a})}catch(a){r({error:a.message})}finally{r({isLoading:!1})}},saveProduct:async s=>{try{const a=await y.savePharmacyProduct(s);return r(n=>n.products.find(l=>l.id===a.id)?{products:n.products.map(l=>l.id===a.id?a:l)}:{products:[a,...n.products]}),a}catch(a){throw a}},deleteProduct:async s=>{try{await y.deletePharmacyProduct(s),r(a=>({products:a.products.filter(n=>n.id!==s)}))}catch(a){throw a}}})),xe=({product:r,onEdit:c,onDelete:s})=>{const a=r.meta||{},n=a.expirationDate?Math.ceil((new Date(a.expirationDate)-new Date)/(1e3*60*60*24)):999,t=n<0,l=n<90&&!t;return e.jsxs(V,{className:"rounded-xl overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all group bg-white h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 flex items-start justify-between bg-slate-50 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg text-blue-600",children:e.jsx(P,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-900 leading-tight",children:r.name}),e.jsx("p",{className:"text-xs text-slate-500",children:a.laboratory||"Laboratorio Genérico"})]})]}),a.requiresPrescription&&e.jsx(ae,{variant:"outline",className:"text-red-600 border-red-200 bg-red-50 text-[10px]",children:"Rx"})]}),e.jsxs(z,{className:"p-4 flex-1 flex flex-col gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded border border-gray-100",children:[e.jsx("span",{className:"text-gray-400 block mb-1",children:"Lote"}),e.jsx("span",{className:"font-mono text-slate-700",children:a.batchNumber||"N/A"})]}),e.jsxs("div",{className:`p-2 rounded border ${t?"bg-red-50 border-red-200":l?"bg-orange-50 border-orange-200":"bg-green-50 border-green-200"}`,children:[e.jsx("span",{className:`block mb-1 ${t?"text-red-400":"text-gray-400"}`,children:"Vence"}),e.jsx("span",{className:`font-bold ${t?"text-red-700":"text-slate-700"}`,children:a.expirationDate||"N/A"})]})]}),e.jsxs("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-lg font-bold text-blue-900",children:["$",Number(r.price).toLocaleString()]}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Stock: ",r.stock]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-blue-600",onClick:()=>c(r),children:e.jsx(te,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-red-600",onClick:()=>s(r.id),children:e.jsx($,{className:"h-4 w-4"})})]})]})]})]})},be=()=>{const{products:r,fetchProducts:c,saveProduct:s,deleteProduct:a,isLoading:n}=k(),{store:t}=re(),[l,x]=h.useState(""),[d,p]=h.useState(!1),[w,C]=h.useState(!1),[N,S]=h.useState(null),[o,m]=h.useState({name:"",price:"",stock:"1",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""});h.useEffect(()=>{t!=null&&t.id&&c(t.id)},[t==null?void 0:t.id,c]);const T=r.filter(i=>i.name.toLowerCase().includes(l.toLowerCase())),M=()=>{S(null),m({name:"",price:"",stock:"10",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""}),p(!0)},_=i=>{S(i);const g=i.meta||{};m({name:i.name,price:i.price,stock:i.stock,description:i.description||"",...g}),p(!0)},L=async i=>{i.preventDefault(),C(!0);try{const g={id:N?N.id:void 0,name:o.name,price:parseFloat(o.price),stock:parseInt(o.stock),product_type:"physical",requires_shipping:!0,description:o.description,category:"Farmacia",store_id:t==null?void 0:t.id,meta:{expirationDate:o.expirationDate,batchNumber:o.batchNumber,requiresPrescription:o.requiresPrescription,presentation:o.presentation,laboratory:o.laboratory}};await s(g),q({title:N?"Medicamento actualizado":"Medicamento registrado"}),p(!1)}catch(g){console.error(g),q({title:"Error",variant:"destructive"})}finally{C(!1)}},E=async i=>{window.confirm("¿Retirar medicamento?")&&await a(i)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-100 p-6 rounded-2xl flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-blue-900 flex items-center gap-2",children:[e.jsx(P,{className:"h-8 w-8 text-blue-600"}),"Inventario Farmacéutico"]}),e.jsx("p",{className:"text-blue-700 mt-1",children:"Control de vencimientos, lotes y regencia."})]}),e.jsxs(v,{className:"bg-blue-600 hover:bg-blue-700 rounded-full",onClick:M,children:[e.jsx(I,{className:"h-4 w-4 mr-2"})," Nuevo Medicamento"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:T.map(i=>e.jsx(xe,{product:{...i,discount:0},onEdit:_,onDelete:E},i.id))}),e.jsx(O,{open:d,onOpenChange:p,children:e.jsxs(F,{className:"sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsx(B,{children:e.jsx(R,{children:"Gestión de Medicamento"})}),e.jsxs("form",{onSubmit:L,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(u,{children:"Nombre Comercial / Genérico"}),e.jsx(f,{value:o.name,onChange:i=>m({...o,name:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Laboratorio"}),e.jsx(f,{value:o.laboratory,onChange:i=>m({...o,laboratory:i.target.value}),placeholder:"Ej: Bayer, MK"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Presentación"}),e.jsxs(K,{value:o.presentation,onValueChange:i=>m({...o,presentation:i}),children:[e.jsx(W,{children:e.jsx(X,{})}),e.jsxs(Y,{children:[e.jsx(j,{value:"Caja",children:"Caja"}),e.jsx(j,{value:"Frasco",children:"Frasco"}),e.jsx(j,{value:"Tableta",children:"Tableta"}),e.jsx(j,{value:"Ampolla",children:"Ampolla"}),e.jsx(j,{value:"Unidad",children:"Unidad"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Lote"}),e.jsx(f,{value:o.batchNumber,onChange:i=>m({...o,batchNumber:i.target.value}),placeholder:"B-123456"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Fecha Vencimiento"}),e.jsx(f,{type:"date",value:o.expirationDate,onChange:i=>m({...o,expirationDate:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Precio Venta"}),e.jsx(f,{type:"number",value:o.price,onChange:i=>m({...o,price:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Stock Disponible"}),e.jsx(f,{type:"number",value:o.stock,onChange:i=>m({...o,stock:i.target.value}),required:!0})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-3 rounded border border-red-100",children:[e.jsx(u,{className:"text-red-800",children:"¿Requiere Fórmula Médica?"}),e.jsx(ee,{checked:o.requiresPrescription,onCheckedChange:i=>m({...o,requiresPrescription:i})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Indicaciones / Descripción"}),e.jsx(Z,{value:o.description,onChange:i=>m({...o,description:i.target.value})})]}),e.jsx(v,{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700",disabled:w,children:w?e.jsx(U,{className:"animate-spin"}):"Guardar Medicamento"})]})]})})]})},ra=h.memo(({store:r})=>{const c=[{path:"",label:"Resumen",icon:H,element:e.jsx(Q,{storeId:r.id})},{path:"caja",label:"Caja (POS)",icon:me,element:e.jsx(ie,{useStore:k,title:"Farmacia - Caja"})},{path:"inventario",label:"Medicamentos",icon:P,element:e.jsx(be,{})},{path:"pedidos",label:"Historial Pedidos",icon:G,element:e.jsx(se,{storeId:r.id})},{path:"clientes",label:"Pacientes",icon:D,element:e.jsx(le,{})},{path:"importar",label:"Importar",icon:pe,element:e.jsx(oe,{storeId:r.id,onProductsUploaded:()=>{}})},{path:"finanzas",label:"Finanzas",icon:ue,element:e.jsx(ne,{storeId:r.id})},{path:"equipo",label:"Farmacéuticos",icon:D,element:e.jsx(ce,{storeId:r.id})},{path:"configuracion",label:"Configuración",icon:he,element:e.jsx(de,{})}];return e.jsx(J,{store:r,tabs:c})});export{ra as default};
