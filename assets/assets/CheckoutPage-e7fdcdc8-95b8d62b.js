import{D as $,c as T,C as L,j as k,b as N,w as u,y as e,x as D,d as v,f as E,h as b,p as w,A as z,_ as C}from"./index-2ce94096.js";import{G as F}from"./Helmet-c26e192a-711588c7.js";import{l as M}from"./input-30c35c11-b44761b2.js";import{u as S}from"./label-a4c1a31d-e949b025.js";import{t as B}from"./textarea-d838bc32-b9870e6c.js";import{r as G}from"./arrow-left-15196fcd-4539f4d9.js";import{o as V}from"./map-pin-4c971ad0-cfbd587c.js";import{o as H}from"./triangle-alert-0cea0848-982fead7.js";const I=2e3,P=4e3,A={Pendiente:["Confirmado","Cancelado"],"Pendiente de pago en efectivo":["Confirmado","Cancelado"],Confirmado:["En preparación","Cancelado"],"En preparación":["Listo para recogida","Cancelado"],"Listo para recogida":["En curso"],"En curso":["Entregado"],Entregado:[],Cancelado:[]},h={PEDIDO_NO_ENCONTRADO:"No se encontró el pedido especificado",TRANSICION_INVALIDA:"Transición de estado no permitida",DATOS_INCOMPLETOS:"Faltan datos requeridos para crear el pedido",ERROR_CREACION:"No se pudo crear el pedido"};function O(r,s="ID"){if(!r||typeof r!="string"||r.trim()==="")throw new Error(`${s} es requerido y debe ser válido`)}function Y(r,s){const t=A[r];return t&&t.includes(s)}function c(r,s){throw console.error(`[orderService] ${s}:`,r),new Error(r.message||s)}const J={async crearPedido(r,s){if(!r||!r.customer_id||!r.store_id)throw new Error(h.DATOS_INCOMPLETOS);if(!s||!Array.isArray(s)||s.length===0)throw new Error("El pedido debe tener al menos un producto");if(!r.delivery_address)throw new Error("La dirección de entrega es requerida");try{const t=s.reduce((p,j)=>p+Number(j.price)*Number(j.quantity),0),d=I,o=P,n=t+d+o,m=r.payment_method==="efectivo"?"Pendiente de pago en efectivo":"Pendiente",{data:l,error:x}=await u.from("orders").insert({customer_id:r.customer_id,store_id:r.store_id,delivery_address:r.delivery_address,delivery_lat:r.delivery_lat,delivery_lng:r.delivery_lng,payment_method:r.payment_method||"efectivo",notes:r.notes,subtotal:t,service_fee:d,delivery_fee:o,total:n,status:m}).select().single();x&&c(x,h.ERROR_CREACION);const g=s.map(p=>({order_id:l.id,product_id:p.product_id,quantity:Number(p.quantity),price:Number(p.price)})),{error:_}=await u.from("order_items").insert(g);return _&&(await u.from("orders").delete().eq("id",l.id),c(_,"Error creando items del pedido")),l}catch(t){c(t,h.ERROR_CREACION)}},async obtenerPedidoPorId(r){O(r,"ID del pedido");try{const{data:s,error:t}=await u.from("orders").select(`
          *,
          stores (id, name, address, phone, image_url, lat, lng),
          profiles (id, full_name, phone, email),
          order_items (
            id, 
            quantity, 
            price,
            products!order_items_product_id_fkey (id, name, image_url, description)
          ),
          deliveries (
            id,
            status,
            delivery_person_id,
            assigned_at,
            picked_up_at,
            delivered_at,
            profiles (full_name, phone)
          )
        `).eq("id",r).single();return t&&c(t,h.PEDIDO_NO_ENCONTRADO),s}catch(s){c(s,h.PEDIDO_NO_ENCONTRADO)}},async actualizarEstado(r,s,t=!1){if(O(r,"ID del pedido"),!s)throw new Error("El nuevo estado es requerido");try{const{data:d,error:o}=await u.from("orders").select("status").eq("id",r).single();if(o&&c(o,h.PEDIDO_NO_ENCONTRADO),!t&&!Y(d.status,s))throw new Error(`${h.TRANSICION_INVALIDA}: No se puede cambiar de "${d.status}" a "${s}"`);const{data:n,error:m}=await u.from("orders").update({status:s,updated_at:new Date().toISOString()}).eq("id",r).select().single();return m&&c(m,"Error actualizando estado"),n}catch(d){c(d,"Error actualizando estado del pedido")}},async cancelarPedido(r,s=null){O(r,"ID del pedido");try{const{data:t,error:d}=await u.from("orders").select("status").eq("id",r).single();if(d&&c(d,h.PEDIDO_NO_ENCONTRADO),["En curso","Entregado","Cancelado"].includes(t.status))throw new Error(`No se puede cancelar un pedido en estado "${t.status}"`);const{data:o,error:n}=await u.from("orders").update({status:"Cancelado",cancellation_reason:s,cancelled_at:new Date().toISOString()}).eq("id",r).select().single();return n&&c(n,"Error cancelando pedido"),o}catch(t){c(t,"Error al cancelar el pedido")}},calcularTotal(r,s=!0){if(!r||!Array.isArray(r))return{subtotal:0,tarifaServicio:0,tarifaEnvio:0,total:0};const t=r.reduce((m,l)=>{const x=Number(l.price)||0,g=Number(l.quantity)||0;return m+x*g},0),d=s?I:0,o=s?P:0,n=t+d+o;return{subtotal:t,tarifaServicio:d,tarifaEnvio:o,total:n}},sePuedeCancelar(r){return!["En curso","Entregado","Cancelado"].includes(r)},obtenerTransicionesDisponibles(r){return A[r]||[]}},se=()=>{const{user:r}=$(),s=T(),t=L(a=>a.items),{getCartTotal:d,clearCart:o}=k(),[n,m]=N.useState(!1),[l,x]=N.useState(""),[g,_]=N.useState(""),p=d(),j=N.useMemo(()=>t.reduce((a,i)=>{const f=i.store_id;return a[f]||(a[f]={store_id:f,store_name:i.stores.name,items:[],total:0}),a[f].items.push(i),a[f].total+=i.price*i.quantity,a},{}),[t]);N.useEffect(()=>{if(!r){s("/cliente/login?redirect=/checkout");return}if(t.length===0){s("/productos");return}(async()=>{const{data:a}=await u.from("profiles").select("address").eq("id",r.id).single();a&&a.address&&x(a.address)})()},[r,t.length,s]);const q=async()=>{if(!l.trim()){C({title:"Dirección requerida",description:"Por favor ingresa una dirección de entrega.",variant:"destructive"});return}m(!0);try{const a=Object.values(j);for(const i of a){const f={customer_id:r.id,store_id:i.store_id,delivery_address:l,payment_method:"efectivo",notes:g,total:i.total},R=i.items.map(y=>({product_id:y.id,quantity:y.quantity,price:y.price}));await J.crearPedido(f,R)}await new Promise(i=>setTimeout(i,1e3)),C({title:"¡Pedido Realizado!",description:`Se han creado ${a.length} orden(es) exitosamente.`}),o(),s("/cliente/dashboard?tab=pedidos")}catch(a){console.error("Checkout error:",a),C({title:"Error al procesar",description:a.message||"Hubo un problema registrando tu pedido.",variant:"destructive"})}finally{m(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(F,{children:e.jsx("title",{children:"Finalizar Compra - Domicilios MiOriente"})}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(D,{variant:"ghost",onClick:()=>s(-1),className:"mb-4",children:[e.jsx(G,{className:"mr-2 h-4 w-4"}),"Volver"]}),e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Finalizar Compra"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(v,{children:[e.jsx(E,{children:e.jsxs(b,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5"})," Dirección de Entrega"]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"address",children:"Dirección y Barrio"}),e.jsx(M,{id:"address",placeholder:"Ej: Calle 5 #4-20, Barrio Centro",value:l,onChange:a=>x(a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"notes",children:"Instrucciones Adicionales (Opcional)"}),e.jsx(B,{id:"notes",placeholder:"Ej: Casa blanca de dos pisos, golpear fuerte...",value:g,onChange:a=>_(a.target.value)})]})]})]}),e.jsxs(v,{children:[e.jsx(E,{children:e.jsx(b,{children:"Items del Pedido"})}),e.jsx(w,{className:"space-y-6",children:Object.values(j).map(a=>e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsxs("h3",{className:"font-bold mb-3 text-lg flex justify-between",children:[e.jsx("span",{children:a.store_name}),e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["Subtotal: $",a.total.toLocaleString()]})]}),e.jsx("div",{className:"space-y-2",children:a.items.map(i=>e.jsxs("div",{className:"flex justify-between items-center text-sm bg-white p-2 rounded border-b last:border-0 border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[i.image_url&&e.jsx("img",{src:i.image_url,alt:i.name,className:"h-10 w-10 object-cover rounded"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Cant: ",i.quantity]})]})]}),e.jsxs("p",{children:["$",(i.price*i.quantity).toLocaleString()]})]},i.id))})]},a.store_id))})]})]}),e.jsx("div",{children:e.jsxs(v,{className:"sticky top-24",children:[e.jsx(E,{children:e.jsx(b,{children:"Resumen de Pago"})}),e.jsxs(w,{className:"space-y-6",children:[e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 rounded-md text-xs text-yellow-800",children:[e.jsxs("p",{className:"font-bold flex items-center gap-1",children:[e.jsx(H,{className:"h-3 w-3"})," Modo Simulación"]}),e.jsxs("p",{children:["Las órdenes se registrarán en el sistema como ",e.jsx("strong",{children:"Pendientes de Pago"}),"."]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal Productos"}),e.jsxs("span",{children:["$",p.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Servicio (Est.)"}),e.jsx("span",{children:"$2,000"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Domicilio Base (Est.)"}),e.jsx("span",{children:"$3,500"})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total Estimado"}),e.jsxs("span",{children:["$",(p+5500).toLocaleString()]})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx(D,{onClick:q,className:"w-full bg-green-600 hover:bg-green-700",size:"lg",disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}),"Procesando..."]}):"Confirmar Pedido"}),e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"Al confirmar, aceptas nuestros términos y condiciones."})]})]})]})})]})]})]})};export{se as default};
