import{k as m,x as P,n as L,u as $,i as k,r as j,j as e,B as I,C as E,a as v,b as C,c as b,f as F,t as w}from"./index-9083a265.js";import{H as z}from"./Helmet-a3f46ffc.js";import{I as M}from"./input-f40b5322.js";import{L as A}from"./label-9012fa84.js";import{T as V}from"./textarea-c7c4cb4e.js";import{A as B}from"./arrow-left-48017677.js";import{M as H}from"./map-pin-9a40b828.js";import{T as U}from"./triangle-alert-00791701.js";const D=2e3,S=4e3,R={Pendiente:["Confirmado","Cancelado"],"Pendiente de pago en efectivo":["Confirmado","Cancelado"],Confirmado:["En preparación","Cancelado"],"En preparación":["Listo para recogida","Cancelado"],"Listo para recogida":["En curso"],"En curso":["Entregado"],Entregado:[],Cancelado:[]},f={PEDIDO_NO_ENCONTRADO:"No se encontró el pedido especificado",TRANSICION_INVALIDA:"Transición de estado no permitida",DATOS_INCOMPLETOS:"Faltan datos requeridos para crear el pedido",ERROR_CREACION:"No se pudo crear el pedido"};function O(r,s="ID"){if(!r||typeof r!="string"||r.trim()==="")throw new Error(`${s} es requerido y debe ser válido`)}function G(r,s){const a=R[r];return a&&a.includes(s)}function c(r,s){throw console.error(`[orderService] ${s}:`,r),new Error(r.message||s)}const Y={async crearPedido(r,s){if(!r||!r.customer_id||!r.store_id)throw new Error(f.DATOS_INCOMPLETOS);if(!s||!Array.isArray(s)||s.length===0)throw new Error("El pedido debe tener al menos un producto");if(!r.delivery_address)throw new Error("La dirección de entrega es requerida");try{const a=s.reduce((p,N)=>p+Number(N.price)*Number(N.quantity),0),n=D,d=S,l=a+n+d,i=r.payment_method==="efectivo"?"Pendiente de pago en efectivo":"Pendiente",{data:u,error:h}=await m.from("orders").insert({customer_id:r.customer_id,store_id:r.store_id,delivery_address:r.delivery_address,delivery_lat:r.delivery_lat,delivery_lng:r.delivery_lng,payment_method:r.payment_method||"efectivo",notes:r.notes,subtotal:a,service_fee:n,delivery_fee:d,total:l,status:i}).select().single();h&&c(h,f.ERROR_CREACION);const g=s.map(p=>({order_id:u.id,product_id:p.product_id,quantity:Number(p.quantity),price:Number(p.price)})),{error:_}=await m.from("order_items").insert(g);return _&&(await m.from("orders").delete().eq("id",u.id),c(_,"Error creando items del pedido")),u}catch(a){c(a,f.ERROR_CREACION)}},async obtenerPedidoPorId(r){O(r,"ID del pedido");try{const{data:s,error:a}=await m.from("orders").select(`
          *,
          stores (id, name, address, phone, image_url, lat, lng),
          profiles (id, full_name, phone, email),
          order_items (
            id, 
            quantity, 
            price,
            products!order_items_product_id_fkey (id, name, image_url, description)
          ),
          deliveries (
            id,
            status,
            delivery_person_id,
            assigned_at,
            picked_up_at,
            delivered_at,
            profiles (full_name, phone)
          )
        `).eq("id",r).single();return a&&c(a,f.PEDIDO_NO_ENCONTRADO),s}catch(s){c(s,f.PEDIDO_NO_ENCONTRADO)}},async actualizarEstado(r,s,a=!1){if(O(r,"ID del pedido"),!s)throw new Error("El nuevo estado es requerido");try{const{data:n,error:d}=await m.from("orders").select("status").eq("id",r).single();if(d&&c(d,f.PEDIDO_NO_ENCONTRADO),!a&&!G(n.status,s))throw new Error(`${f.TRANSICION_INVALIDA}: No se puede cambiar de "${n.status}" a "${s}"`);const{data:l,error:i}=await m.from("orders").update({status:s,updated_at:new Date().toISOString()}).eq("id",r).select().single();return i&&c(i,"Error actualizando estado"),l}catch(n){c(n,"Error actualizando estado del pedido")}},async cancelarPedido(r,s=null){O(r,"ID del pedido");try{const{data:a,error:n}=await m.from("orders").select("status").eq("id",r).single();if(n&&c(n,f.PEDIDO_NO_ENCONTRADO),["En curso","Entregado","Cancelado"].includes(a.status))throw new Error(`No se puede cancelar un pedido en estado "${a.status}"`);const{data:l,error:i}=await m.from("orders").update({status:"Cancelado",cancellation_reason:s,cancelled_at:new Date().toISOString()}).eq("id",r).select().single();return i&&c(i,"Error cancelando pedido"),l}catch(a){c(a,"Error al cancelar el pedido")}},calcularTotal(r,s=!0){if(!r||!Array.isArray(r))return{subtotal:0,tarifaServicio:0,tarifaEnvio:0,total:0};const a=r.reduce((i,u)=>{const h=Number(u.price)||0,g=Number(u.quantity)||0;return i+h*g},0),n=s?D:0,d=s?S:0,l=a+n+d;return{subtotal:a,tarifaServicio:n,tarifaEnvio:d,total:l}},sePuedeCancelar(r){return!["En curso","Entregado","Cancelado"].includes(r)},obtenerTransicionesDisponibles(r){return R[r]||[]}},se=()=>{const{user:r}=P(),s=L(),a=$(o=>o.items),{getCartTotal:n,clearCart:d}=k(),[l,i]=j.useState(!1),[u,h]=j.useState(""),[g,_]=j.useState(""),p=n(),N=j.useMemo(()=>a.reduce((o,t)=>{const x=t.store_id;return o[x]||(o[x]={store_id:x,store_name:t.stores.name,items:[],total:0}),o[x].items.push(t),o[x].total+=t.price*t.quantity,o},{}),[a]);j.useEffect(()=>{if(!r){s("/cliente/login?redirect=/checkout");return}if(a.length===0){s("/productos");return}(async()=>{const{data:t}=await m.from("profiles").select("address").eq("id",r.id).single();t&&t.address&&h(t.address)})()},[r,a.length,s]);const T=async()=>{if(!u.trim()){w({title:"Dirección requerida",description:"Por favor ingresa una dirección de entrega.",variant:"destructive"});return}i(!0);try{const o=Object.values(N);for(const t of o){const x={customer_id:r.id,store_id:t.store_id,delivery_address:u,payment_method:"efectivo",notes:g,total:t.total},q=t.items.map(y=>({product_id:y.id,quantity:y.quantity,price:y.price}));await Y.crearPedido(x,q)}await new Promise(t=>setTimeout(t,1e3)),w({title:"¡Pedido Realizado!",description:`Se han creado ${o.length} orden(es) exitosamente.`}),d(),s("/cliente/dashboard?tab=pedidos")}catch(o){console.error("Checkout error:",o),w({title:"Error al procesar",description:o.message||"Hubo un problema registrando tu pedido.",variant:"destructive"})}finally{i(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(z,{children:e.jsx("title",{children:"Finalizar Compra - Domicilios MiOriente"})}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(I,{variant:"ghost",onClick:()=>s(-1),className:"mb-4",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Volver"]}),e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Finalizar Compra"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(E,{children:[e.jsx(v,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"})," Dirección de Entrega"]})}),e.jsxs(b,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"address",children:"Dirección y Barrio"}),e.jsx(M,{id:"address",placeholder:"Ej: Calle 5 #4-20, Barrio Centro",value:u,onChange:o=>h(o.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"notes",children:"Instrucciones Adicionales (Opcional)"}),e.jsx(V,{id:"notes",placeholder:"Ej: Casa blanca de dos pisos, golpear fuerte...",value:g,onChange:o=>_(o.target.value)})]})]})]}),e.jsxs(E,{children:[e.jsx(v,{children:e.jsx(C,{children:"Items del Pedido"})}),e.jsx(b,{className:"space-y-6",children:Object.values(N).map(o=>e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsxs("h3",{className:"font-bold mb-3 text-lg flex justify-between",children:[e.jsx("span",{children:o.store_name}),e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["Subtotal: $",o.total.toLocaleString()]})]}),e.jsx("div",{className:"space-y-2",children:o.items.map(t=>e.jsxs("div",{className:"flex justify-between items-center text-sm bg-white p-2 rounded border-b last:border-0 border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[t.image_url&&e.jsx("img",{src:t.image_url,alt:t.name,className:"h-10 w-10 object-cover rounded"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Cant: ",t.quantity]})]})]}),e.jsxs("p",{children:["$",(t.price*t.quantity).toLocaleString()]})]},t.id))})]},o.store_id))})]})]}),e.jsx("div",{children:e.jsxs(E,{className:"sticky top-24",children:[e.jsx(v,{children:e.jsx(C,{children:"Resumen de Pago"})}),e.jsxs(b,{className:"space-y-6",children:[e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 rounded-md text-xs text-yellow-800",children:[e.jsxs("p",{className:"font-bold flex items-center gap-1",children:[e.jsx(U,{className:"h-3 w-3"})," Modo Simulación"]}),e.jsxs("p",{children:["Las órdenes se registrarán en el sistema como ",e.jsx("strong",{children:"Pendientes de Pago"}),"."]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal Productos"}),e.jsxs("span",{children:["$",p.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Servicio (Est.)"}),e.jsx("span",{children:"$2,000"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Domicilio Base (Est.)"}),e.jsx("span",{children:"$3,500"})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total Estimado"}),e.jsxs("span",{children:["$",(p+5500).toLocaleString()]})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx(I,{onClick:T,className:"w-full bg-green-600 hover:bg-green-700",size:"lg",disabled:l,children:l?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}),"Procesando..."]}):"Confirmar Pedido"}),e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"Al confirmar, aceptas nuestros términos y condiciones."})]})]})]})})]})]})]})};export{se as default};
