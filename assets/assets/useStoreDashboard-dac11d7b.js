import{k as i,Q as _}from"./index-9083a265.js";const h="No se encontró la tienda solicitada",p="No se pudieron cargar los productos",m="No se pudieron cargar los pedidos",y="No se pudieron cargar las estadísticas";function l(r,o="ID"){if(!r||typeof r!="string"||r.trim()==="")throw new Error(`${o} es requerido y debe ser una cadena válida`)}function c(r,o){throw console.error(`[storeService] ${o}:`,r),r.code==="PGRST116"?new Error("No se encontraron resultados"):r.code==="23503"?new Error("Referencia a un registro que no existe"):r.code==="23505"?new Error("Ya existe un registro con esos datos"):new Error(r.message||o)}const d={async obtenerTiendaPorPropietario(r){l(r,"ID del propietario");try{const{data:o,error:e}=await i.from("stores").select("*, service_categories(name)").eq("owner_id",r).maybeSingle();return e&&c(e,h),o}catch(o){c(o,h)}},async actualizarTienda(r,o){l(r,"ID de la tienda");try{const{data:e,error:t}=await i.from("stores").update(o).eq("id",r).select().single();return t&&c(t,"Error actualizando tienda"),e}catch(e){throw e}},async obtenerClientesTienda(r){l(r,"ID de la tienda");try{const{data:o,error:e}=await i.from("orders").select(`
                  customer_id,
                  profiles:customer_id (id, full_name, email, phone, avatar_url),
                  created_at,
                  total
              `).eq("store_id",r).order("created_at",{ascending:!1});if(e)throw e;const t=new Map;return o.forEach(a=>{if(!a.profiles)return;const s=a.customer_id;t.has(s)||t.set(s,{...a.profiles,last_order:a.created_at,total_spent:0,total_orders:0});const n=t.get(s);n.total_spent+=Number(a.total),n.total_orders+=1}),Array.from(t.values())}catch(o){return console.error("Error cargando clientes",o),[]}},async getStoreByOwner(r){return this.obtenerTiendaPorPropietario(r)},async obtenerEstadisticasTienda(r){l(r,"ID de la tienda");try{const{data:o,error:e}=await i.rpc("get_store_stats",{p_store_id:r});return e&&c(e,y),(o==null?void 0:o[0])||{}}catch(o){c(o,y)}},async getStoreStats(r){return this.obtenerEstadisticasTienda(r)},async obtenerIngresosMensuales(r){l(r,"ID de la tienda");try{const{data:o,error:e}=await i.from("orders").select("created_at, total").eq("store_id",r).eq("status","Entregado").order("created_at",{ascending:!0});e&&c(e,"Error obteniendo ingresos mensuales");const t={};return o==null||o.forEach(a=>{const n=new Date(a.created_at).toLocaleString("es-CO",{month:"short"}),u=Number(a.total)||0;t[n]=(t[n]||0)+u}),Object.entries(t).map(([a,s])=>({mes:a,total:s}))}catch(o){return console.error("[storeService] Error en obtenerIngresosMensuales:",o),[]}},async getMonthlyIncome(r){return this.obtenerIngresosMensuales(r)},async obtenerProductos(r){l(r,"ID de la tienda");try{const{data:o,error:e}=await i.from("products").select("*").eq("store_id",r).order("created_at",{ascending:!1});return e&&c(e,p),o||[]}catch(o){c(o,p)}},async getProducts(r){return this.obtenerProductos(r)},async crearProducto(r){if(!r||!r.store_id)throw new Error("Los datos del producto son requeridos");try{const{data:o,error:e}=await i.from("products").insert(r).select().single();return e&&c(e,"Error creando producto"),o}catch(o){c(o,"Error creando producto")}},async actualizarProducto(r,o){l(r,"ID del producto");try{const{data:e,error:t}=await i.from("products").update(o).eq("id",r).select().single();return t&&c(t,"Error actualizando producto"),e}catch(e){c(e,"Error actualizando producto")}},async eliminarProducto(r){l(r,"ID del producto");try{const{error:o}=await i.from("products").delete().eq("id",r);o&&c(o,"Error eliminando producto")}catch(o){c(o,"Error eliminando producto")}},async obtenerPedidos(r){l(r,"ID de la tienda");try{const{data:o,error:e}=await i.from("orders").select(`
          *, 
          profiles(full_name, phone, email), 
          order_items(id, quantity, price, products!order_items_product_id_fkey(name, image_url)),
          deliveries(status, delivery_person_id, profiles(full_name, phone))
        `).eq("store_id",r).order("created_at",{ascending:!1});return e&&c(e,m),o||[]}catch(o){c(o,m)}},async getOrders(r){return this.obtenerPedidos(r)},async actualizarEstadoPedido(r,o){if(l(r,"ID del pedido"),!o||typeof o!="string")throw new Error("El estado del pedido es requerido");try{const{data:e,error:t}=await i.from("orders").update({status:o}).eq("id",r).select().single();return t&&c(t,"Error actualizando estado del pedido"),e}catch(e){c(e,"Error actualizando estado del pedido")}},async updateOrderStatus(r,o){return this.actualizarEstadoPedido(r,o)},async eliminarPedido(r){l(r,"ID del pedido");try{const{error:o}=await i.from("orders").delete().eq("id",r);o&&c(o,"Error eliminando pedido")}catch(o){c(o,"Error eliminando pedido")}},async deleteOrder(r){return this.eliminarPedido(r)}},f=12e4,E=15e3,w=_((r,o)=>({store:null,stats:null,orders:[],products:[],customers:[],isLoadingStore:!1,isLoadingStats:!1,isLoadingOrders:!1,isLoadingProducts:!1,isLoadingCustomers:!1,error:null,lastFetch:{stats:0,orders:0,products:0,customers:0},setStore:e=>r({store:e}),updateStoreSettings:async e=>{const t=o().store;if(t)try{const a=await d.actualizarTienda(t.id,e);return r({store:a}),a}catch(a){throw a}},fetchCustomers:async e=>{if(!e)return;const t=Date.now();if(!(t-o().lastFetch.customers<3e5&&o().customers.length>0)){r({isLoadingCustomers:!0});try{const a=await d.obtenerClientesTienda(e);r(s=>({customers:a,lastFetch:{...s.lastFetch,customers:t}}))}catch(a){console.error(a)}finally{r({isLoadingCustomers:!1})}}},clearError:()=>r({error:null}),fetchStoreData:async e=>{if(!e){console.warn("[useStoreDashboard] fetchStoreData: userId requerido");return}const t=o().store;if(t&&t.owner_id===e)return;r({isLoadingStore:!0,error:null});const a=setTimeout(()=>{o().isLoadingStore&&r({isLoadingStore:!1,error:"Tiempo de espera agotado. Por favor recarga la página."})},E);try{const s=await d.obtenerTiendaPorPropietario(e);clearTimeout(a),r({store:s}),s&&o().fetchStats(s.id)}catch(s){console.error("[useStoreDashboard] Error cargando tienda:",s),clearTimeout(a),r({error:"No se pudo cargar la información del negocio."})}finally{r({isLoadingStore:!1})}},fetchStats:async(e,t=!1)=>{if(!e)return;const a=Date.now(),s=o().lastFetch.stats;if(!(!t&&a-s<f&&o().stats)){r({isLoadingStats:!0});try{const[n,u]=await Promise.all([d.obtenerEstadisticasTienda(e).catch(()=>({})),d.obtenerIngresosMensuales(e).catch(()=>[])]);r(g=>({stats:{...n,monthlyIncome:u},lastFetch:{...g.lastFetch,stats:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando estadísticas:",n)}finally{r({isLoadingStats:!1})}}},fetchOrders:async(e,t=!1)=>{if(!e)return;const a=Date.now(),s=o().lastFetch.orders;if(!(!t&&a-s<f&&o().orders.length>0)){r({isLoadingOrders:!0});try{const n=await d.obtenerPedidos(e);r(u=>({orders:n,lastFetch:{...u.lastFetch,orders:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando pedidos:",n)}finally{r({isLoadingOrders:!1})}}},fetchProducts:async(e,t=!1)=>{if(!e)return;const a=Date.now(),s=o().lastFetch.products;if(!(!t&&a-s<f&&o().products.length>0)){r({isLoadingProducts:!0});try{const n=await d.obtenerProductos(e);r(u=>({products:n,lastFetch:{...u.lastFetch,products:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando productos:",n)}finally{r({isLoadingProducts:!1})}}},updateOrderStatus:async(e,t)=>{if(!e||!t)throw new Error("ID del pedido y estado son requeridos");try{await d.actualizarEstadoPedido(e,t),r(a=>({orders:a.orders.map(s=>s.id===e?{...s,status:t}:s)}))}catch(a){throw console.error("[useStoreDashboard] Error actualizando pedido:",a),a}},deleteOrder:async e=>{if(!e)throw new Error("ID requerido");try{await d.eliminarPedido(e),r(t=>({orders:t.orders.filter(a=>a.id!==e)}))}catch(t){throw console.error("Error deleting order:",t),t}},addProduct:async e=>{if(!e)throw new Error("Datos del producto son requeridos");try{const t=await d.crearProducto(e);return r(a=>{var s;return{products:[t,...a.products],stats:a.stats?{...a.stats,total_products:Number(((s=a.stats)==null?void 0:s.total_products)||0)+1}:a.stats}}),t}catch(t){throw console.error("[useStoreDashboard] Error creando producto:",t),t}},updateProduct:async(e,t)=>{if(!e||!t)throw new Error("ID del producto y actualizaciones son requeridos");try{const a=await d.actualizarProducto(e,t);return r(s=>({products:s.products.map(n=>n.id===e?{...n,...a}:n)})),a}catch(a){throw console.error("[useStoreDashboard] Error actualizando producto:",a),a}},deleteProduct:async e=>{if(!e)throw new Error("ID del producto es requerido");try{await d.eliminarProducto(e),r(t=>{var a;return{products:t.products.filter(s=>s.id!==e),stats:t.stats?{...t.stats,total_products:Math.max(0,Number(((a=t.stats)==null?void 0:a.total_products)||0)-1)}:t.stats}})}catch(t){throw console.error("[useStoreDashboard] Error eliminando producto:",t),t}},invalidateCache:()=>{r({lastFetch:{stats:0,orders:0,products:0}})},reset:()=>{r({store:null,stats:null,orders:[],products:[],isLoadingStore:!1,isLoadingStats:!1,isLoadingOrders:!1,isLoadingProducts:!1,error:null,lastFetch:{stats:0,orders:0,products:0}})}})),D=Object.freeze(Object.defineProperty({__proto__:null,default:w,useStoreDashboard:w},Symbol.toStringTag,{value:"Module"}));export{D as a,d as s,w as u};
