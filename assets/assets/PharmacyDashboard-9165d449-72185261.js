import{u as I,b as h,y as e,Y as $,w as b,x as v,F as E,q as O,i as R,H as T,J as V,A as z,d as H,p as G,X as J,_ as k}from"./index-2ce94096.js";import{R as U,_ as B}from"./BaseStoreDashboard-e6c3d8a1-4e64a417.js";import X from"./OverviewTab-4d90d2b2-2472bb25.js";import{l as j}from"./input-30c35c11-b44761b2.js";import{k as Y,O as K,V as Q,I as W,M as f}from"./select-f8f9a097-f8aafdb0.js";import{u}from"./label-a4c1a31d-e949b025.js";import{t as Z}from"./textarea-d838bc32-b9870e6c.js";import{F as ee}from"./switch-e312fcab-e79e6118.js";import{d as te}from"./badge-aa6603fa-a4f8275d.js";import{u as ae}from"./useStoreDashboard-6e1233c7-c0c33d1b.js";import{l as w}from"./pill-3e84f193-d51c0d39.js";import{c as re}from"./pencil-fe5409bf-721c7957.js";import se from"./OrdersTab-bbdc2219-8f06d749.js";import ie from"./GenericPOSView-837e2cc5-c84fd532.js";import{B as oe}from"./BulkUploadTab-3e25ba5e-0feebfa1.js";import ce from"./FinancialsTab-aa1c096f-73719405.js";import ne from"./AdminTab-383d089a-5b305ef9.js";import{U as de,k as le}from"./StoreCustomersTab-a98fd0a4-2cfcce8b.js";import{c as me}from"./credit-card-a50d43c9-92f7ec06.js";import{r as S}from"./users-1e3e6770-1b81f4c4.js";import{t as pe}from"./upload-7019e91d-5c44e162.js";import{a as ue,n as he}from"./settings-030bd9e5-67a41fef.js";import"./Helmet-c26e192a-711588c7.js";import"./log-out-8e22b546-d2fb474d.js";import"./index-bd02b651-8cbaad37.js";import"./triangle-alert-0cea0848-982fead7.js";import"./package-8a53cd5c-b574c2fa.js";import"./trending-up-6d925098-59ad96bf.js";import"./check-d1d3ff5a-31b10f76.js";import"./clock-87f27ea4-2e4bce74.js";import"./truck-4de66a3b-1e0700fb.js";import"./map-pin-4c971ad0-cfbd587c.js";import"./scroll-area-305a242e-4c6bab7e.js";import"./shopping-cart-539ff770-43b9593e.js";import"./search-34f7aa01-f8dfb85b.js";import"./circle-check-big-e18572b1-a21d79ae.js";import"./circle-alert-9e1a28d8-b20db8b3.js";import"./user-plus-413d81fa-4edbf458.js";import"./index-dcb504c2-12f47de7.js";const y={_parseMetadata(a){var n;if(!a)return a;let s={expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""};const t=(n=a.description)==null?void 0:n.match(/PHARMA_META:\s*({.*})/s);let c=a.description||"";if(t)try{s={...s,...JSON.parse(t[1])},c=a.description.replace(/\n\nPHARMA_META:\s*{.*}/s,"")}catch{}return{...a,meta:s,description:c,full_description:a.description}},async getPharmacyProducts(a){const{data:n,error:s}=await b.from("products").select("*").eq("store_id",a).order("created_at",{ascending:!1});if(s)throw s;return n.map(this._parseMetadata)},async savePharmacyProduct(a){const{meta:n,description:s,...t}=a,c=JSON.stringify(n),r=`${s||""}

PHARMA_META: ${c}`,d={...t,description:r};if(d.id){const{data:x,error:l}=await b.from("products").update(d).eq("id",d.id).select().single();if(l)throw l;return this._parseMetadata(x)}else{const{data:x,error:l}=await b.from("products").insert(d).select().single();if(l)throw l;return this._parseMetadata(x)}},async deletePharmacyProduct(a){const{error:n}=await b.from("products").delete().eq("id",a);if(n)throw n},async createPOSTransaction({orderPayload:a,items:n}){const{data:s,error:t}=await b.from("orders").insert(a).select().single();if(t)throw t;const c=n.map(d=>({order_id:s.id,product_id:d.id,quantity:d.qty,price:d.price})),{error:r}=await b.from("order_items").insert(c);if(r)throw console.error("Error creating items",r),r;return s}},_=I((a,n)=>({products:[],cart:[],isLoadingCheckout:!1,addToCart:s=>{const t=n().cart,c=t.find(r=>r.id===s.id);if(c){if(c.qty>=s.stock)return!1;a({cart:t.map(r=>r.id===s.id?{...r,qty:r.qty+1}:r)})}else a({cart:[...t,{...s,qty:1}]});return!0},removeFromCart:s=>{a(t=>({cart:t.cart.filter(c=>c.id!==s)}))},updateCartQty:(s,t)=>{a(c=>({cart:c.cart.map(r=>{if(r.id===s){const d=Math.max(1,r.qty+t);return t>0&&d>r.stock?r:{...r,qty:d}}return r})}))},clearCart:()=>a({cart:[]}),processCheckout:async(s,t,c,r)=>{const d=n().cart;if(d.length===0)return;const x=typeof t=="object"?{name:t.name,doc_id:t.docId,phone:t.phone,email:t.email,method:c,type:"POS"}:{name:t,method:c,type:"POS"};a({isLoadingCheckout:!0});try{const l={store_id:s,customer_id:null,status:"Entregado",total:r,delivery_address:JSON.stringify({guest:x,items:d.map(p=>({id:p.id,name:p.name,qty:p.qty,price:p.price}))})};return await y.createPOSTransaction({orderPayload:l,items:d}),n().clearCart(),n().fetchProducts(s),!0}catch(l){throw l}finally{a({isLoadingCheckout:!1})}},isLoading:!1,error:null,fetchProducts:async s=>{a({isLoading:!0,error:null});try{const t=await y.getPharmacyProducts(s);a({products:t})}catch(t){a({error:t.message})}finally{a({isLoading:!1})}},saveProduct:async s=>{try{const t=await y.savePharmacyProduct(s);return a(c=>c.products.find(r=>r.id===t.id)?{products:c.products.map(r=>r.id===t.id?t:r)}:{products:[t,...c.products]}),t}catch(t){throw t}},deleteProduct:async s=>{try{await y.deletePharmacyProduct(s),a(t=>({products:t.products.filter(c=>c.id!==s)}))}catch(t){throw t}}})),xe=({product:a,onEdit:n,onDelete:s})=>{const t=a.meta||{},c=t.expirationDate?Math.ceil((new Date(t.expirationDate)-new Date)/(1e3*60*60*24)):999,r=c<0,d=c<90&&!r;return e.jsxs(H,{className:"rounded-xl overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all group bg-white h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 flex items-start justify-between bg-slate-50 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg text-blue-600",children:e.jsx(w,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-900 leading-tight",children:a.name}),e.jsx("p",{className:"text-xs text-slate-500",children:t.laboratory||"Laboratorio Genérico"})]})]}),t.requiresPrescription&&e.jsx(te,{variant:"outline",className:"text-red-600 border-red-200 bg-red-50 text-[10px]",children:"Rx"})]}),e.jsxs(G,{className:"p-4 flex-1 flex flex-col gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded border border-gray-100",children:[e.jsx("span",{className:"text-gray-400 block mb-1",children:"Lote"}),e.jsx("span",{className:"font-mono text-slate-700",children:t.batchNumber||"N/A"})]}),e.jsxs("div",{className:`p-2 rounded border ${r?"bg-red-50 border-red-200":d?"bg-orange-50 border-orange-200":"bg-green-50 border-green-200"}`,children:[e.jsx("span",{className:`block mb-1 ${r?"text-red-400":"text-gray-400"}`,children:"Vence"}),e.jsx("span",{className:`font-bold ${r?"text-red-700":"text-slate-700"}`,children:t.expirationDate||"N/A"})]})]}),e.jsxs("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-lg font-bold text-blue-900",children:["$",Number(a.price).toLocaleString()]}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Stock: ",a.stock]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-blue-600",onClick:()=>n(a),children:e.jsx(re,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-red-600",onClick:()=>s(a.id),children:e.jsx(J,{className:"h-4 w-4"})})]})]})]})]})},be=()=>{const{products:a,fetchProducts:n,saveProduct:s,deleteProduct:t,isLoading:c}=_(),{store:r}=ae(),[d,x]=h.useState(""),[l,p]=h.useState(!1),[P,C]=h.useState(!1),[N,q]=h.useState(null),[o,m]=h.useState({name:"",price:"",stock:"1",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""});h.useEffect(()=>{r!=null&&r.id&&n(r.id)},[r==null?void 0:r.id,n]);const M=a.filter(i=>i.name.toLowerCase().includes(d.toLowerCase())),D=()=>{q(null),m({name:"",price:"",stock:"10",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""}),p(!0)},A=i=>{q(i);const g=i.meta||{};m({name:i.name,price:i.price,stock:i.stock,description:i.description||"",...g}),p(!0)},L=async i=>{i.preventDefault(),C(!0);try{const g={id:N?N.id:void 0,name:o.name,price:parseFloat(o.price),stock:parseInt(o.stock),product_type:"physical",requires_shipping:!0,description:o.description,category:"Farmacia",store_id:r==null?void 0:r.id,meta:{expirationDate:o.expirationDate,batchNumber:o.batchNumber,requiresPrescription:o.requiresPrescription,presentation:o.presentation,laboratory:o.laboratory}};await s(g),k({title:N?"Medicamento actualizado":"Medicamento registrado"}),p(!1)}catch(g){console.error(g),k({title:"Error",variant:"destructive"})}finally{C(!1)}},F=async i=>{window.confirm("¿Retirar medicamento?")&&await t(i)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-100 p-6 rounded-2xl flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-blue-900 flex items-center gap-2",children:[e.jsx(w,{className:"h-8 w-8 text-blue-600"}),"Inventario Farmacéutico"]}),e.jsx("p",{className:"text-blue-700 mt-1",children:"Control de vencimientos, lotes y regencia."})]}),e.jsxs(v,{className:"bg-blue-600 hover:bg-blue-700 rounded-full",onClick:D,children:[e.jsx(E,{className:"h-4 w-4 mr-2"})," Nuevo Medicamento"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:M.map(i=>e.jsx(xe,{product:{...i,discount:0},onEdit:A,onDelete:F},i.id))}),e.jsx(O,{open:l,onOpenChange:p,children:e.jsxs(R,{className:"sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsx(T,{children:e.jsx(V,{children:"Gestión de Medicamento"})}),e.jsxs("form",{onSubmit:L,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(u,{children:"Nombre Comercial / Genérico"}),e.jsx(j,{value:o.name,onChange:i=>m({...o,name:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Laboratorio"}),e.jsx(j,{value:o.laboratory,onChange:i=>m({...o,laboratory:i.target.value}),placeholder:"Ej: Bayer, MK"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Presentación"}),e.jsxs(Y,{value:o.presentation,onValueChange:i=>m({...o,presentation:i}),children:[e.jsx(K,{children:e.jsx(Q,{})}),e.jsxs(W,{children:[e.jsx(f,{value:"Caja",children:"Caja"}),e.jsx(f,{value:"Frasco",children:"Frasco"}),e.jsx(f,{value:"Tableta",children:"Tableta"}),e.jsx(f,{value:"Ampolla",children:"Ampolla"}),e.jsx(f,{value:"Unidad",children:"Unidad"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Lote"}),e.jsx(j,{value:o.batchNumber,onChange:i=>m({...o,batchNumber:i.target.value}),placeholder:"B-123456"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Fecha Vencimiento"}),e.jsx(j,{type:"date",value:o.expirationDate,onChange:i=>m({...o,expirationDate:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Precio Venta"}),e.jsx(j,{type:"number",value:o.price,onChange:i=>m({...o,price:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Stock Disponible"}),e.jsx(j,{type:"number",value:o.stock,onChange:i=>m({...o,stock:i.target.value}),required:!0})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-3 rounded border border-red-100",children:[e.jsx(u,{className:"text-red-800",children:"¿Requiere Fórmula Médica?"}),e.jsx(ee,{checked:o.requiresPrescription,onCheckedChange:i=>m({...o,requiresPrescription:i})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Indicaciones / Descripción"}),e.jsx(Z,{value:o.description,onChange:i=>m({...o,description:i.target.value})})]}),e.jsx(v,{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700",disabled:P,children:P?e.jsx(z,{className:"animate-spin"}):"Guardar Medicamento"})]})]})})]})},at=h.memo(({store:a})=>{const n=[{path:"",label:"Resumen",icon:U,element:e.jsx(X,{storeId:a.id})},{path:"caja",label:"Caja (POS)",icon:me,element:e.jsx(ie,{useStore:_,title:"Farmacia - Caja"})},{path:"inventario",label:"Medicamentos",icon:w,element:e.jsx(be,{})},{path:"pedidos",label:"Historial Pedidos",icon:$,element:e.jsx(se,{storeId:a.id})},{path:"clientes",label:"Pacientes",icon:S,element:e.jsx(de,{})},{path:"importar",label:"Importar",icon:pe,element:e.jsx(oe,{storeId:a.id,onProductsUploaded:()=>{}})},{path:"finanzas",label:"Finanzas",icon:ue,element:e.jsx(ce,{storeId:a.id})},{path:"equipo",label:"Farmacéuticos",icon:S,element:e.jsx(ne,{storeId:a.id})},{path:"configuracion",label:"Configuración",icon:he,element:e.jsx(le,{})}];return e.jsx(B,{store:a,tabs:n})});export{at as default};
