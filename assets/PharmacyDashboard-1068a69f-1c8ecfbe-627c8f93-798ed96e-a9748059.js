import{A as F,f as h,y as e,g as E,k as j,x as v,Z as I,m as T,n as O,I as R,T as H,W as z,a as G,d as B,B as J,N as k}from"./index-87ab05f1.js";import{E as V,G as U}from"./BaseStoreDashboard-9ad5c13e-d7a1a933-4e4e637d-e46edf80-92fa8562.js";import W from"./OverviewTab-a01a807a-07dd1735-5ada0bfc-c4caa4a6-82fd39ae.js";import{a as b}from"./input-977568de-bea10295-4adb3258-368f21ef-dd0395aa.js";import{$ as Z,T as K,H as Q,D as X,_ as g}from"./select-03f52418-c5111b6c-af5e7482-637f31c9-c1fa3325.js";import{u}from"./label-6ced007b-31f64b09-71156226-1e4e75c4-8af8544c.js";import{l as Y}from"./textarea-03a75c76-69040bf5-35a9782e-8e0ca7dd-b23a1c90.js";import{J as ee}from"./switch-4dcb0898-6baf1f34-94caad3b-b2c05987-912e253f.js";import{d as re}from"./badge-34bdff7c-b2c90fce-efd43af8-f7a84e83-2020d777.js";import{u as te}from"./useStoreDashboard-6cfa5bdd-a014cfe4-c8bff8db-4123484f-ad5d382b.js";import{o as w}from"./pill-926d8fcb-40569885-5dca1407-bfdce0ab-5ae15732.js";import{k as ae}from"./pencil-b145156d-81e39600-5a684db5-7834b695-6280cdd5.js";import se from"./OrdersManagementTab-74307886-48065a75-18a01665-f134e541-ee33a121.js";import ie from"./GenericPOSView-65865e30-e48d2479-1f7364f9-da5c4b26-51e5425d.js";import{B as oe}from"./BulkUploadTab-0fe3efc4-824a62de-987b67e9-4bcf2828-9a124cc2.js";import ce from"./FinancialsTab-e07ef4f8-cb7c3ea0-71aba4e2-cf3d1041-f4dca4a9.js";import ne from"./AdminTab-1ef2bbd0-38fe81f3-dd6c0adf-0124de59-ea200bc2.js";import{F as de,E as le}from"./StoreCustomersTab-ce620322-3ebc43ae-d65f30bd-3e3d1ad2-1f973f81.js";import{y as me}from"./credit-card-bcc8ac59-e0a7eb79-9e00e665-407b30eb-fd4bd701.js";import{r as _}from"./users-93d0d9a2-82ed9403-42cfbbc5-b53a716c-9b48157b.js";import{t as pe}from"./upload-8259cec2-21216fe4-eb25a68c-1da87379-90ddbf9a.js";import{c as ue,o as he}from"./settings-96af137d-f461a4db-8933cd88-d7585a9f-df6ebdcf.js";import"./Helmet-d9a99439-17d17245-80416325-0a82370e-5a6bde15.js";import"./log-out-1de3e3ee-53ee1d6f-be22ed5f-31659d2d-18bff071.js";import"./index-6c60542e-1f0cc56c-a6179bc2-c5eb0dfa-9596aa86.js";import"./triangle-alert-5ea4272b-316ec065-d63fb5c5-7c95de1a-02bb8d63.js";import"./package-99b0a55c-785e5cf1-bac652b0-c1d00408-aa7462ee.js";import"./trending-up-147c55bb-4628ab85-e3b835f1-1f811d81-76ad9897.js";import"./check-78166ef5-9630779a-ee565adf-12fad7f6-47c88872.js";import"./clock-0a32af33-121834d9-4cd0de5d-d758c7ab-1bf2afff.js";import"./truck-a0071c63-090d128d-9cfc595e-b33772c3-de5cb612.js";import"./map-pin-4396fd6c-98f8e615-be2face5-18973d83-0f5a17cb.js";import"./scroll-area-d0c9b1aa-5d11dc0b-4a9e3f1e-c4827a88-a3cd7b48.js";import"./shopping-cart-8aca5ef3-095b1616-112594bf-3a6e2763-072beeee.js";import"./search-566f00ed-c3babbf0-ad60b5b7-3e645f27-67335d64.js";import"./circle-check-big-68527463-8ad93454-9bdb44d7-ad5a0975-66385ab6.js";import"./circle-alert-58769497-aeae36dd-aab7d564-c8980787-32b03cc8.js";import"./user-plus-74362f50-3e37ce73-40475d04-0b128926-0d3181b2.js";import"./index-e23a302d-1b9287b5-b6450a0d-35f60f24-c4974312.js";const y={_parseMetadata(t){var n;if(!t)return t;let s={expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""};const r=(n=t.description)==null?void 0:n.match(/PHARMA_META:\s*({.*})/s);let c=t.description||"";if(r)try{s={...s,...JSON.parse(r[1])},c=t.description.replace(/\n\nPHARMA_META:\s*{.*}/s,"")}catch{}return{...t,meta:s,description:c,full_description:t.description}},async getPharmacyProducts(t){const{data:n,error:s}=await j.from("products").select("*").eq("store_id",t).order("created_at",{ascending:!1});if(s)throw s;return n.map(this._parseMetadata)},async savePharmacyProduct(t){const{meta:n,description:s,...r}=t,c=JSON.stringify(n),a=`${s||""}

PHARMA_META: ${c}`,d={...r,description:a};if(d.id){const{data:x,error:l}=await j.from("products").update(d).eq("id",d.id).select().single();if(l)throw l;return this._parseMetadata(x)}else{const{data:x,error:l}=await j.from("products").insert(d).select().single();if(l)throw l;return this._parseMetadata(x)}},async deletePharmacyProduct(t){const{error:n}=await j.from("products").delete().eq("id",t);if(n)throw n},async createPOSTransaction({orderPayload:t,items:n}){const{data:s,error:r}=await j.from("orders").insert(t).select().single();if(r)throw r;const c=n.map(d=>({order_id:s.id,product_id:d.id,quantity:d.qty,price:d.price})),{error:a}=await j.from("order_items").insert(c);if(a)throw console.error("Error creating items",a),a;return s}},M=F((t,n)=>({products:[],cart:[],isLoadingCheckout:!1,addToCart:s=>{const r=n().cart,c=r.find(a=>a.id===s.id);if(c){if(c.qty>=s.stock)return!1;t({cart:r.map(a=>a.id===s.id?{...a,qty:a.qty+1}:a)})}else t({cart:[...r,{...s,qty:1}]});return!0},removeFromCart:s=>{t(r=>({cart:r.cart.filter(c=>c.id!==s)}))},updateCartQty:(s,r)=>{t(c=>({cart:c.cart.map(a=>{if(a.id===s){const d=Math.max(1,a.qty+r);return r>0&&d>a.stock?a:{...a,qty:d}}return a})}))},clearCart:()=>t({cart:[]}),processCheckout:async(s,r,c,a)=>{const d=n().cart;if(d.length===0)return;const x=typeof r=="object"?{name:r.name,doc_id:r.docId,phone:r.phone,email:r.email,method:c,type:"POS"}:{name:r,method:c,type:"POS"};t({isLoadingCheckout:!0});try{const l={store_id:s,customer_id:null,status:"Entregado",total:a,delivery_address:JSON.stringify({guest:x,items:d.map(p=>({id:p.id,name:p.name,qty:p.qty,price:p.price}))})};return await y.createPOSTransaction({orderPayload:l,items:d}),n().clearCart(),n().fetchProducts(s),!0}catch(l){throw l}finally{t({isLoadingCheckout:!1})}},isLoading:!1,error:null,fetchProducts:async s=>{t({isLoading:!0,error:null});try{const r=await y.getPharmacyProducts(s);t({products:r})}catch(r){t({error:r.message})}finally{t({isLoading:!1})}},saveProduct:async s=>{try{const r=await y.savePharmacyProduct(s);return t(c=>c.products.find(a=>a.id===r.id)?{products:c.products.map(a=>a.id===r.id?r:a)}:{products:[r,...c.products]}),r}catch(r){throw r}},deleteProduct:async s=>{try{await y.deletePharmacyProduct(s),t(r=>({products:r.products.filter(c=>c.id!==s)}))}catch(r){throw r}}})),xe=({product:t,onEdit:n,onDelete:s})=>{const r=t.meta||{},c=r.expirationDate?Math.ceil((new Date(r.expirationDate)-new Date)/(1e3*60*60*24)):999,a=c<0,d=c<90&&!a;return e.jsxs(G,{className:"rounded-xl overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all group bg-white h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 flex items-start justify-between bg-slate-50 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg text-blue-600",children:e.jsx(w,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-900 leading-tight",children:t.name}),e.jsx("p",{className:"text-xs text-slate-500",children:r.laboratory||"Laboratorio Genérico"})]})]}),r.requiresPrescription&&e.jsx(re,{variant:"outline",className:"text-red-600 border-red-200 bg-red-50 text-[10px]",children:"Rx"})]}),e.jsxs(B,{className:"p-4 flex-1 flex flex-col gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded border border-gray-100",children:[e.jsx("span",{className:"text-gray-400 block mb-1",children:"Lote"}),e.jsx("span",{className:"font-mono text-slate-700",children:r.batchNumber||"N/A"})]}),e.jsxs("div",{className:`p-2 rounded border ${a?"bg-red-50 border-red-200":d?"bg-orange-50 border-orange-200":"bg-green-50 border-green-200"}`,children:[e.jsx("span",{className:`block mb-1 ${a?"text-red-400":"text-gray-400"}`,children:"Vence"}),e.jsx("span",{className:`font-bold ${a?"text-red-700":"text-slate-700"}`,children:r.expirationDate||"N/A"})]})]}),e.jsxs("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-lg font-bold text-blue-900",children:["$",Number(t.price).toLocaleString()]}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Stock: ",t.stock]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-blue-600",onClick:()=>n(t),children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-red-600",onClick:()=>s(t.id),children:e.jsx(J,{className:"h-4 w-4"})})]})]})]})]})},je=()=>{const{products:t,fetchProducts:n,saveProduct:s,deleteProduct:r,isLoading:c}=M(),{store:a}=te(),[d,x]=h.useState(""),[l,p]=h.useState(!1),[P,C]=h.useState(!1),[N,q]=h.useState(null),[o,m]=h.useState({name:"",price:"",stock:"1",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""});h.useEffect(()=>{a!=null&&a.id&&n(a.id)},[a==null?void 0:a.id,n]);const S=t.filter(i=>i.name.toLowerCase().includes(d.toLowerCase())),D=()=>{q(null),m({name:"",price:"",stock:"10",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""}),p(!0)},$=i=>{q(i);const f=i.meta||{};m({name:i.name,price:i.price,stock:i.stock,description:i.description||"",...f}),p(!0)},A=async i=>{i.preventDefault(),C(!0);try{const f={id:N?N.id:void 0,name:o.name,price:parseFloat(o.price),stock:parseInt(o.stock),product_type:"physical",requires_shipping:!0,description:o.description,category:"Farmacia",store_id:a==null?void 0:a.id,meta:{expirationDate:o.expirationDate,batchNumber:o.batchNumber,requiresPrescription:o.requiresPrescription,presentation:o.presentation,laboratory:o.laboratory}};await s(f),k({title:N?"Medicamento actualizado":"Medicamento registrado"}),p(!1)}catch(f){console.error(f),k({title:"Error",variant:"destructive"})}finally{C(!1)}},L=async i=>{window.confirm("¿Retirar medicamento?")&&await r(i)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-100 p-6 rounded-2xl flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-blue-900 flex items-center gap-2",children:[e.jsx(w,{className:"h-8 w-8 text-blue-600"}),"Inventario Farmacéutico"]}),e.jsx("p",{className:"text-blue-700 mt-1",children:"Control de vencimientos, lotes y regencia."})]}),e.jsxs(v,{className:"bg-blue-600 hover:bg-blue-700 rounded-full",onClick:D,children:[e.jsx(I,{className:"h-4 w-4 mr-2"})," Nuevo Medicamento"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:S.map(i=>e.jsx(xe,{product:{...i,discount:0},onEdit:$,onDelete:L},i.id))}),e.jsx(T,{open:l,onOpenChange:p,children:e.jsxs(O,{className:"sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsx(R,{children:e.jsx(H,{children:"Gestión de Medicamento"})}),e.jsxs("form",{onSubmit:A,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(u,{children:"Nombre Comercial / Genérico"}),e.jsx(b,{value:o.name,onChange:i=>m({...o,name:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Laboratorio"}),e.jsx(b,{value:o.laboratory,onChange:i=>m({...o,laboratory:i.target.value}),placeholder:"Ej: Bayer, MK"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Presentación"}),e.jsxs(Z,{value:o.presentation,onValueChange:i=>m({...o,presentation:i}),children:[e.jsx(K,{children:e.jsx(Q,{})}),e.jsxs(X,{children:[e.jsx(g,{value:"Caja",children:"Caja"}),e.jsx(g,{value:"Frasco",children:"Frasco"}),e.jsx(g,{value:"Tableta",children:"Tableta"}),e.jsx(g,{value:"Ampolla",children:"Ampolla"}),e.jsx(g,{value:"Unidad",children:"Unidad"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Lote"}),e.jsx(b,{value:o.batchNumber,onChange:i=>m({...o,batchNumber:i.target.value}),placeholder:"B-123456"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Fecha Vencimiento"}),e.jsx(b,{type:"date",value:o.expirationDate,onChange:i=>m({...o,expirationDate:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Precio Venta"}),e.jsx(b,{type:"number",value:o.price,onChange:i=>m({...o,price:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Stock Disponible"}),e.jsx(b,{type:"number",value:o.stock,onChange:i=>m({...o,stock:i.target.value}),required:!0})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-3 rounded border border-red-100",children:[e.jsx(u,{className:"text-red-800",children:"¿Requiere Fórmula Médica?"}),e.jsx(ee,{checked:o.requiresPrescription,onCheckedChange:i=>m({...o,requiresPrescription:i})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Indicaciones / Descripción"}),e.jsx(Y,{value:o.description,onChange:i=>m({...o,description:i.target.value})})]}),e.jsx(v,{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700",disabled:P,children:P?e.jsx(z,{className:"animate-spin"}):"Guardar Medicamento"})]})]})})]})},tr=h.memo(({store:t})=>{const n=[{path:"",label:"Resumen",icon:V,element:e.jsx(W,{storeId:t.id})},{path:"caja",label:"Caja (POS)",icon:me,element:e.jsx(ie,{useStore:M,title:"Farmacia - Caja"})},{path:"inventario",label:"Medicamentos",icon:w,element:e.jsx(je,{})},{path:"pedidos",label:"Historial Pedidos",icon:E,element:e.jsx(se,{storeId:t.id})},{path:"clientes",label:"Pacientes",icon:_,element:e.jsx(de,{})},{path:"importar",label:"Importar",icon:pe,element:e.jsx(oe,{storeId:t.id,onProductsUploaded:()=>{}})},{path:"finanzas",label:"Finanzas",icon:ue,element:e.jsx(ce,{storeId:t.id})},{path:"equipo",label:"Farmacéuticos",icon:_,element:e.jsx(ne,{storeId:t.id})},{path:"configuracion",label:"Configuración",icon:he,element:e.jsx(le,{})}];return e.jsx(U,{store:t,tabs:n})});export{tr as default};
