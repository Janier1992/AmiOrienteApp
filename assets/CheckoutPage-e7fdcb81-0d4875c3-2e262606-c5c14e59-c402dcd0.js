import{D as T,M as $,e as L,H as k,f as N,k as u,y as e,x as D,a as v,b,c as E,d as w,W as z,N as C}from"./index-87ab05f1.js";import{K as F}from"./Helmet-d9a99439-17d17245-80416325-0a82370e-5a6bde15.js";import{a as M}from"./input-977568de-bea10295-4adb3258-368f21ef-dd0395aa.js";import{u as I}from"./label-6ced007b-31f64b09-71156226-1e4e75c4-8af8544c.js";import{l as B}from"./textarea-03a75c76-69040bf5-35a9782e-8e0ca7dd-b23a1c90.js";import{o as H}from"./arrow-left-31a92935-5b9af42a-b9eb07e5-5c243bbe-6fa97975.js";import{e as K}from"./map-pin-4396fd6c-98f8e615-be2face5-18973d83-0f5a17cb.js";import{e as V}from"./triangle-alert-5ea4272b-316ec065-d63fb5c5-7c95de1a-02bb8d63.js";const P=2e3,S=4e3,q={Pendiente:["Confirmado","Cancelado"],"Pendiente de pago en efectivo":["Confirmado","Cancelado"],Confirmado:["En preparación","Cancelado"],"En preparación":["Listo para recogida","Cancelado"],"Listo para recogida":["En curso"],"En curso":["Entregado"],Entregado:[],Cancelado:[]},x={PEDIDO_NO_ENCONTRADO:"No se encontró el pedido especificado",TRANSICION_INVALIDA:"Transición de estado no permitida",DATOS_INCOMPLETOS:"Faltan datos requeridos para crear el pedido",ERROR_CREACION:"No se pudo crear el pedido"};function O(r,s="ID"){if(!r||typeof r!="string"||r.trim()==="")throw new Error(`${s} es requerido y debe ser válido`)}function W(r,s){const a=q[r];return a&&a.includes(s)}function c(r,s){throw console.error(`[orderService] ${s}:`,r),new Error(r.message||s)}const Y={async crearPedido(r,s){if(!r||!r.customer_id||!r.store_id)throw new Error(x.DATOS_INCOMPLETOS);if(!s||!Array.isArray(s)||s.length===0)throw new Error("El pedido debe tener al menos un producto");if(!r.delivery_address)throw new Error("La dirección de entrega es requerida");try{const a=s.reduce((p,j)=>p+Number(j.price)*Number(j.quantity),0),o=P,d=S,n=a+o+d,m=r.payment_method==="efectivo"?"Pendiente de pago en efectivo":"Pendiente",{data:l,error:h}=await u.from("orders").insert({customer_id:r.customer_id,store_id:r.store_id,delivery_address:r.delivery_address,delivery_lat:r.delivery_lat,delivery_lng:r.delivery_lng,payment_method:r.payment_method||"efectivo",notes:r.notes,subtotal:a,service_fee:o,delivery_fee:d,total:n,status:m}).select().single();h&&c(h,x.ERROR_CREACION);const g=s.map(p=>({order_id:l.id,product_id:p.product_id,quantity:Number(p.quantity),price:Number(p.price)})),{error:_}=await u.from("order_items").insert(g);return _&&(await u.from("orders").delete().eq("id",l.id),c(_,"Error creando items del pedido")),l}catch(a){c(a,x.ERROR_CREACION)}},async obtenerPedidoPorId(r){O(r,"ID del pedido");try{const{data:s,error:a}=await u.from("orders").select(`
          *,
          stores (id, name, address, phone, image_url, lat, lng),
          profiles (id, full_name, phone, email),
          order_items (
            id, 
            quantity, 
            price,
            products!order_items_product_id_fkey (id, name, image_url, description)
          ),
          deliveries (
            id,
            status,
            delivery_person_id,
            assigned_at,
            picked_up_at,
            delivered_at,
            profiles (full_name, phone)
          )
        `).eq("id",r).single();return a&&c(a,x.PEDIDO_NO_ENCONTRADO),s}catch(s){c(s,x.PEDIDO_NO_ENCONTRADO)}},async actualizarEstado(r,s,a=!1){if(O(r,"ID del pedido"),!s)throw new Error("El nuevo estado es requerido");try{const{data:o,error:d}=await u.from("orders").select("status").eq("id",r).single();if(d&&c(d,x.PEDIDO_NO_ENCONTRADO),!a&&!W(o.status,s))throw new Error(`${x.TRANSICION_INVALIDA}: No se puede cambiar de "${o.status}" a "${s}"`);const{data:n,error:m}=await u.from("orders").update({status:s,updated_at:new Date().toISOString()}).eq("id",r).select().single();return m&&c(m,"Error actualizando estado"),n}catch(o){c(o,"Error actualizando estado del pedido")}},async cancelarPedido(r,s=null){O(r,"ID del pedido");try{const{data:a,error:o}=await u.from("orders").select("status").eq("id",r).single();if(o&&c(o,x.PEDIDO_NO_ENCONTRADO),["En curso","Entregado","Cancelado"].includes(a.status))throw new Error(`No se puede cancelar un pedido en estado "${a.status}"`);const{data:d,error:n}=await u.from("orders").update({status:"Cancelado",cancellation_reason:s,cancelled_at:new Date().toISOString()}).eq("id",r).select().single();return n&&c(n,"Error cancelando pedido"),d}catch(a){c(a,"Error al cancelar el pedido")}},calcularTotal(r,s=!0){if(!r||!Array.isArray(r))return{subtotal:0,tarifaServicio:0,tarifaEnvio:0,total:0};const a=r.reduce((m,l)=>{const h=Number(l.price)||0,g=Number(l.quantity)||0;return m+h*g},0),o=s?P:0,d=s?S:0,n=a+o+d;return{subtotal:a,tarifaServicio:o,tarifaEnvio:d,total:n}},sePuedeCancelar(r){return!["En curso","Entregado","Cancelado"].includes(r)},obtenerTransicionesDisponibles(r){return q[r]||[]}},se=()=>{const{user:r}=T(),s=$(),a=L(t=>t.items),{getCartTotal:o,clearCart:d}=k(),[n,m]=N.useState(!1),[l,h]=N.useState(""),[g,_]=N.useState(""),p=o(),j=N.useMemo(()=>a.reduce((t,i)=>{const f=i.store_id;return t[f]||(t[f]={store_id:f,store_name:i.stores.name,items:[],total:0}),t[f].items.push(i),t[f].total+=i.price*i.quantity,t},{}),[a]);N.useEffect(()=>{if(!r){s("/cliente/login?redirect=/checkout");return}if(a.length===0){s("/productos");return}(async()=>{const{data:t}=await u.from("profiles").select("address").eq("id",r.id).single();t&&t.address&&h(t.address)})()},[r,a.length,s]);const A=async()=>{if(!l.trim()){C({title:"Dirección requerida",description:"Por favor ingresa una dirección de entrega.",variant:"destructive"});return}m(!0);try{const t=Object.values(j);for(const i of t){const f={customer_id:r.id,store_id:i.store_id,delivery_address:l,payment_method:"efectivo",notes:g,total:i.total},R=i.items.map(y=>({product_id:y.id,quantity:y.quantity,price:y.price}));await Y.crearPedido(f,R)}await new Promise(i=>setTimeout(i,1e3)),C({title:"¡Pedido Realizado!",description:`Se han creado ${t.length} orden(es) exitosamente.`}),d(),s("/cliente/dashboard?tab=pedidos")}catch(t){console.error("Checkout error:",t),C({title:"Error al procesar",description:t.message||"Hubo un problema registrando tu pedido.",variant:"destructive"})}finally{m(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(F,{children:e.jsx("title",{children:"Finalizar Compra - Domicilios MiOriente"})}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(D,{variant:"ghost",onClick:()=>s(-1),className:"mb-4",children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Volver"]}),e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Finalizar Compra"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(v,{children:[e.jsx(b,{children:e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5"})," Dirección de Entrega"]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"address",children:"Dirección y Barrio"}),e.jsx(M,{id:"address",placeholder:"Ej: Calle 5 #4-20, Barrio Centro",value:l,onChange:t=>h(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"notes",children:"Instrucciones Adicionales (Opcional)"}),e.jsx(B,{id:"notes",placeholder:"Ej: Casa blanca de dos pisos, golpear fuerte...",value:g,onChange:t=>_(t.target.value)})]})]})]}),e.jsxs(v,{children:[e.jsx(b,{children:e.jsx(E,{children:"Items del Pedido"})}),e.jsx(w,{className:"space-y-6",children:Object.values(j).map(t=>e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsxs("h3",{className:"font-bold mb-3 text-lg flex justify-between",children:[e.jsx("span",{children:t.store_name}),e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["Subtotal: $",t.total.toLocaleString()]})]}),e.jsx("div",{className:"space-y-2",children:t.items.map(i=>e.jsxs("div",{className:"flex justify-between items-center text-sm bg-white p-2 rounded border-b last:border-0 border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[i.image_url&&e.jsx("img",{src:i.image_url,alt:i.name,className:"h-10 w-10 object-cover rounded"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Cant: ",i.quantity]})]})]}),e.jsxs("p",{children:["$",(i.price*i.quantity).toLocaleString()]})]},i.id))})]},t.store_id))})]})]}),e.jsx("div",{children:e.jsxs(v,{className:"sticky top-24",children:[e.jsx(b,{children:e.jsx(E,{children:"Resumen de Pago"})}),e.jsxs(w,{className:"space-y-6",children:[e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 rounded-md text-xs text-yellow-800",children:[e.jsxs("p",{className:"font-bold flex items-center gap-1",children:[e.jsx(V,{className:"h-3 w-3"})," Modo Simulación"]}),e.jsxs("p",{children:["Las órdenes se registrarán en el sistema como ",e.jsx("strong",{children:"Pendientes de Pago"}),"."]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal Productos"}),e.jsxs("span",{children:["$",p.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Servicio (Est.)"}),e.jsx("span",{children:"$2,000"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Domicilio Base (Est.)"}),e.jsx("span",{children:"$3,500"})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total Estimado"}),e.jsxs("span",{children:["$",(p+5500).toLocaleString()]})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx(D,{onClick:A,className:"w-full bg-green-600 hover:bg-green-700",size:"lg",disabled:n,children:n?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"mr-2 h-4 w-4 animate-spin"}),"Procesando..."]}):"Confirmar Pedido"}),e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-2",children:"Al confirmar, aceptas nuestros términos y condiciones."})]})]})]})})]})]})]})};export{se as default};
