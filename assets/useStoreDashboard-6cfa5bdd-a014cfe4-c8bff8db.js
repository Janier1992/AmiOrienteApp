import{w as c,z as _}from"./index-8e3c4911.js";const p="No se encontró la tienda solicitada",m="No se pudieron cargar los productos",g="No se pudieron cargar los pedidos",y="No se pudieron cargar las estadísticas";function i(r,e="ID"){if(!r||typeof r!="string"||r.trim()==="")throw new Error(`${e} es requerido y debe ser una cadena válida`)}function d(r,e){throw console.error(`[storeService] ${e}:`,r),r.code==="PGRST116"?new Error("No se encontraron resultados"):r.code==="23503"?new Error("Referencia a un registro que no existe"):r.code==="23505"?new Error("Ya existe un registro con esos datos"):new Error(r.message||e)}const u={async obtenerTiendaPorPropietario(r){i(r,"ID del propietario");try{const{data:e,error:t}=await c.from("stores").select("*, service_categories(name)").eq("owner_id",r).maybeSingle();return t&&d(t,p),e}catch(e){d(e,p)}},async actualizarTienda(r,e){i(r,"ID de la tienda");try{const{data:t,error:o}=await c.from("stores").update(e).eq("id",r).select().single();return o&&d(o,"Error actualizando tienda"),t}catch(t){throw t}},async obtenerClientesTienda(r){i(r,"ID de la tienda");try{const{data:e,error:t}=await c.from("orders").select(`
                  customer_id,
                  profiles:customer_id (id, full_name, email, phone, avatar_url),
                  created_at,
                  total
              `).eq("store_id",r).order("created_at",{ascending:!1});if(t)throw t;const o=new Map;return e.forEach(a=>{if(!a.profiles)return;const s=a.customer_id;o.has(s)||o.set(s,{...a.profiles,last_order:a.created_at,total_spent:0,total_orders:0});const n=o.get(s);n.total_spent+=Number(a.total),n.total_orders+=1}),Array.from(o.values())}catch(e){return console.error("Error cargando clientes",e),[]}},async getStoreByOwner(r){return this.obtenerTiendaPorPropietario(r)},async obtenerEstadisticasTienda(r){i(r,"ID de la tienda");try{const{data:e,error:t}=await c.rpc("get_store_stats",{p_store_id:r});return t&&d(t,y),(e==null?void 0:e[0])||{}}catch(e){d(e,y)}},async getStoreStats(r){return this.obtenerEstadisticasTienda(r)},async obtenerIngresosMensuales(r){i(r,"ID de la tienda");try{const{data:e,error:t}=await c.from("orders").select("created_at, total").eq("store_id",r).eq("status","Entregado").order("created_at",{ascending:!0});t&&d(t,"Error obteniendo ingresos mensuales");const o={};return e==null||e.forEach(a=>{const s=new Date(a.created_at).toLocaleString("es-CO",{month:"short"}),n=Number(a.total)||0;o[s]=(o[s]||0)+n}),Object.entries(o).map(([a,s])=>({mes:a,total:s}))}catch(e){return console.error("[storeService] Error en obtenerIngresosMensuales:",e),[]}},async getMonthlyIncome(r){return this.obtenerIngresosMensuales(r)},async obtenerProductos(r){i(r,"ID de la tienda");try{const{data:e,error:t}=await c.from("products").select("*").eq("store_id",r).order("created_at",{ascending:!1});return t&&d(t,m),e||[]}catch(e){d(e,m)}},async getProducts(r){return this.obtenerProductos(r)},async crearProducto(r){if(!r||!r.store_id)throw new Error("Los datos del producto son requeridos");try{const{data:e,error:t}=await c.from("products").insert(r).select().single();return t&&d(t,"Error creando producto"),e}catch(e){d(e,"Error creando producto")}},async actualizarProducto(r,e){i(r,"ID del producto");try{const{data:t,error:o}=await c.from("products").update(e).eq("id",r).select().single();return o&&d(o,"Error actualizando producto"),t}catch(t){d(t,"Error actualizando producto")}},async eliminarProducto(r){i(r,"ID del producto");try{const{error:e}=await c.from("products").delete().eq("id",r);e&&d(e,"Error eliminando producto")}catch(e){d(e,"Error eliminando producto")}},async obtenerPedidos(r){i(r,"ID de la tienda");try{const{data:e,error:t}=await c.from("orders").select(`
          *, 
          profiles(full_name, phone, email), 
          order_items(id, quantity, price, products!order_items_product_id_fkey(name, image_url)),
          deliveries(status, delivery_person_id, profiles(full_name, phone))
        `).eq("store_id",r).order("created_at",{ascending:!1});return t&&d(t,g),e||[]}catch(e){d(e,g)}},async getOrders(r){return this.obtenerPedidos(r)},async actualizarEstadoPedido(r,e){if(i(r,"ID del pedido"),!e||typeof e!="string")throw new Error("El estado del pedido es requerido");try{const{data:t,error:o}=await c.from("orders").update({status:e}).eq("id",r).select().single();return o&&d(o,"Error actualizando estado del pedido"),t}catch(t){d(t,"Error actualizando estado del pedido")}},async updateOrderStatus(r,e){return this.actualizarEstadoPedido(r,e)},async eliminarPedido(r){i(r,"ID del pedido");try{const{error:e}=await c.from("orders").delete().eq("id",r);e&&d(e,"Error eliminando pedido")}catch(e){d(e,"Error eliminando pedido")}},async deleteOrder(r){return this.eliminarPedido(r)},async getEquipment(r){i(r,"ID de la tienda");try{const{data:e,error:t}=await c.from("store_equipment").select("*").eq("store_id",r).order("name");if(t)throw t;return e||[]}catch(e){return console.error("[storeService] Error cargando equipos:",e),[]}},async addEquipment(r){try{const{data:e,error:t}=await c.from("store_equipment").insert(r).select().single();if(t)throw t;return e}catch(e){throw console.error("[storeService] Error agregando equipo:",e),e}},async updateEquipment(r,e){try{const{data:t,error:o}=await c.from("store_equipment").update(e).eq("id",r).select().single();if(o)throw o;return t}catch(t){throw console.error("[storeService] Error actualizando equipo:",t),t}},async deleteEquipment(r){try{const{error:e}=await c.from("store_equipment").delete().eq("id",r);if(e)throw e}catch(e){throw console.error("[storeService] Error eliminando equipo:",e),e}},async getMaintenanceLogs(r){try{const{data:e,error:t}=await c.from("maintenance_logs").select("*").eq("equipment_id",r).order("date",{ascending:!1});if(t)throw t;return e||[]}catch(e){return console.error("[storeService] Error cargando bitácora:",e),[]}},async addMaintenanceLog(r){try{const{data:e,error:t}=await c.from("maintenance_logs").insert(r).select().single();if(t)throw t;return e}catch(e){throw console.error("[storeService] Error agregando bitácora:",e),e}}},h=12e4,E=15e3,f=_((r,e)=>({store:null,stats:null,orders:[],products:[],customers:[],isLoadingStore:!1,isLoadingStats:!1,isLoadingOrders:!1,isLoadingProducts:!1,isLoadingCustomers:!1,error:null,lastFetch:{stats:0,orders:0,products:0,customers:0},setStore:t=>r({store:t}),updateStoreSettings:async t=>{const o=e().store;if(o)try{const a=await u.actualizarTienda(o.id,t);return r({store:a}),a}catch(a){throw a}},fetchCustomers:async t=>{if(!t)return;const o=Date.now();if(!(o-e().lastFetch.customers<3e5&&e().customers.length>0)){r({isLoadingCustomers:!0});try{const a=await u.obtenerClientesTienda(t);r(s=>({customers:a,lastFetch:{...s.lastFetch,customers:o}}))}catch(a){console.error(a)}finally{r({isLoadingCustomers:!1})}}},clearError:()=>r({error:null}),fetchStoreData:async t=>{if(!t){console.warn("[useStoreDashboard] fetchStoreData: userId requerido");return}const o=e().store;if(o&&o.owner_id===t)return;r({isLoadingStore:!0,error:null});const a=setTimeout(()=>{e().isLoadingStore&&r({isLoadingStore:!1,error:"Tiempo de espera agotado. Por favor recarga la página."})},E);try{const s=await u.obtenerTiendaPorPropietario(t);clearTimeout(a),r({store:s}),s&&e().fetchStats(s.id)}catch(s){console.error("[useStoreDashboard] Error cargando tienda:",s),clearTimeout(a),r({error:"No se pudo cargar la información del negocio."})}finally{r({isLoadingStore:!1})}},fetchStats:async(t,o=!1)=>{if(!t)return;const a=Date.now(),s=e().lastFetch.stats;if(!(!o&&a-s<h&&e().stats)){r({isLoadingStats:!0});try{const[n,l]=await Promise.all([u.obtenerEstadisticasTienda(t).catch(()=>({})),u.obtenerIngresosMensuales(t).catch(()=>[])]);r(w=>({stats:{...n,monthlyIncome:l},lastFetch:{...w.lastFetch,stats:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando estadísticas:",n)}finally{r({isLoadingStats:!1})}}},fetchOrders:async(t,o=!1)=>{if(!t)return;const a=Date.now(),s=e().lastFetch.orders;if(!(!o&&a-s<h&&e().orders.length>0)){r({isLoadingOrders:!0});try{const n=await u.obtenerPedidos(t);r(l=>({orders:n,lastFetch:{...l.lastFetch,orders:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando pedidos:",n)}finally{r({isLoadingOrders:!1})}}},fetchProducts:async(t,o=!1)=>{if(!t)return;const a=Date.now(),s=e().lastFetch.products;if(!(!o&&a-s<h&&e().products.length>0)){r({isLoadingProducts:!0});try{const n=await u.obtenerProductos(t);r(l=>({products:n,lastFetch:{...l.lastFetch,products:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando productos:",n)}finally{r({isLoadingProducts:!1})}}},updateOrderStatus:async(t,o)=>{if(!t||!o)throw new Error("ID del pedido y estado son requeridos");try{await u.actualizarEstadoPedido(t,o),r(a=>({orders:a.orders.map(s=>s.id===t?{...s,status:o}:s)}))}catch(a){throw console.error("[useStoreDashboard] Error actualizando pedido:",a),a}},deleteOrder:async t=>{if(!t)throw new Error("ID requerido");try{await u.eliminarPedido(t),r(o=>({orders:o.orders.filter(a=>a.id!==t)}))}catch(o){throw console.error("Error deleting order:",o),o}},addProduct:async t=>{if(!t)throw new Error("Datos del producto son requeridos");try{const o=await u.crearProducto(t);return r(a=>{var s;return{products:[o,...a.products],stats:a.stats?{...a.stats,total_products:Number(((s=a.stats)==null?void 0:s.total_products)||0)+1}:a.stats}}),o}catch(o){throw console.error("[useStoreDashboard] Error creando producto:",o),o}},updateProduct:async(t,o)=>{if(!t||!o)throw new Error("ID del producto y actualizaciones son requeridos");try{const a=await u.actualizarProducto(t,o);return r(s=>({products:s.products.map(n=>n.id===t?{...n,...a}:n)})),a}catch(a){throw console.error("[useStoreDashboard] Error actualizando producto:",a),a}},deleteProduct:async t=>{if(!t)throw new Error("ID del producto es requerido");try{await u.eliminarProducto(t),r(o=>{var a;return{products:o.products.filter(s=>s.id!==t),stats:o.stats?{...o.stats,total_products:Math.max(0,Number(((a=o.stats)==null?void 0:a.total_products)||0)-1)}:o.stats}})}catch(o){throw console.error("[useStoreDashboard] Error eliminando producto:",o),o}},invalidateCache:()=>{r({lastFetch:{stats:0,orders:0,products:0}})},reset:()=>{r({store:null,stats:null,orders:[],products:[],isLoadingStore:!1,isLoadingStats:!1,isLoadingOrders:!1,isLoadingProducts:!1,error:null,lastFetch:{stats:0,orders:0,products:0}})}})),b=Object.freeze(Object.defineProperty({__proto__:null,default:f,useStoreDashboard:f},Symbol.toStringTag,{value:"Module"}));export{b as a,u as s,f as u};
