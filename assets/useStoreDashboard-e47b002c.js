import{e as i,v as w}from"./index-6cceb248.js";const h="No se encontró la tienda solicitada",p="No se pudieron cargar los productos",m="No se pudieron cargar los pedidos",y="No se pudieron cargar las estadísticas";function l(r,t="ID"){if(!r||typeof r!="string"||r.trim()==="")throw new Error(`${t} es requerido y debe ser una cadena válida`)}function c(r,t){throw console.error(`[storeService] ${t}:`,r),r.code==="PGRST116"?new Error("No se encontraron resultados"):r.code==="23503"?new Error("Referencia a un registro que no existe"):r.code==="23505"?new Error("Ya existe un registro con esos datos"):new Error(r.message||t)}const d={async obtenerTiendaPorPropietario(r){l(r,"ID del propietario");try{const{data:t,error:e}=await i.from("stores").select("*, service_categories(name)").eq("owner_id",r).maybeSingle();return e&&c(e,h),t}catch(t){c(t,h)}},async actualizarTienda(r,t){l(r,"ID de la tienda");try{const{data:e,error:o}=await i.from("stores").update(t).eq("id",r).select().single();return o&&c(o,"Error actualizando tienda"),e}catch(e){throw e}},async obtenerClientesTienda(r){l(r,"ID de la tienda");try{const{data:t,error:e}=await i.from("orders").select(`
                  customer_id,
                  profiles:customer_id (id, full_name, email, phone, avatar_url),
                  created_at,
                  total
              `).eq("store_id",r).order("created_at",{ascending:!1});if(e)throw e;const o=new Map;return t.forEach(a=>{if(!a.profiles)return;const s=a.customer_id;o.has(s)||o.set(s,{...a.profiles,last_order:a.created_at,total_spent:0,total_orders:0});const n=o.get(s);n.total_spent+=Number(a.total),n.total_orders+=1}),Array.from(o.values())}catch(t){return console.error("Error cargando clientes",t),[]}},async getStoreByOwner(r){return this.obtenerTiendaPorPropietario(r)},async obtenerEstadisticasTienda(r){l(r,"ID de la tienda");try{const{data:t,error:e}=await i.rpc("get_store_stats",{p_store_id:r});return e&&c(e,y),(t==null?void 0:t[0])||{}}catch(t){c(t,y)}},async getStoreStats(r){return this.obtenerEstadisticasTienda(r)},async obtenerIngresosMensuales(r){l(r,"ID de la tienda");try{const{data:t,error:e}=await i.from("orders").select("created_at, total").eq("store_id",r).eq("status","Entregado").order("created_at",{ascending:!0});e&&c(e,"Error obteniendo ingresos mensuales");const o={};return t==null||t.forEach(a=>{const n=new Date(a.created_at).toLocaleString("es-CO",{month:"short"}),u=Number(a.total)||0;o[n]=(o[n]||0)+u}),Object.entries(o).map(([a,s])=>({mes:a,total:s}))}catch(t){return console.error("[storeService] Error en obtenerIngresosMensuales:",t),[]}},async getMonthlyIncome(r){return this.obtenerIngresosMensuales(r)},async obtenerProductos(r){l(r,"ID de la tienda");try{const{data:t,error:e}=await i.from("products").select("*").eq("store_id",r).order("created_at",{ascending:!1});return e&&c(e,p),t||[]}catch(t){c(t,p)}},async getProducts(r){return this.obtenerProductos(r)},async crearProducto(r){if(!r||!r.store_id)throw new Error("Los datos del producto son requeridos");try{const{data:t,error:e}=await i.from("products").insert(r).select().single();return e&&c(e,"Error creando producto"),t}catch(t){c(t,"Error creando producto")}},async actualizarProducto(r,t){l(r,"ID del producto");try{const{data:e,error:o}=await i.from("products").update(t).eq("id",r).select().single();return o&&c(o,"Error actualizando producto"),e}catch(e){c(e,"Error actualizando producto")}},async eliminarProducto(r){l(r,"ID del producto");try{const{error:t}=await i.from("products").delete().eq("id",r);t&&c(t,"Error eliminando producto")}catch(t){c(t,"Error eliminando producto")}},async obtenerPedidos(r){l(r,"ID de la tienda");try{const{data:t,error:e}=await i.from("orders").select(`
          *, 
          profiles(full_name, phone, email), 
          order_items(id, quantity, price, products!order_items_product_id_fkey(name, image_url)),
          deliveries(status, delivery_person_id, profiles(full_name, phone))
        `).eq("store_id",r).order("created_at",{ascending:!1});return e&&c(e,m),t||[]}catch(t){c(t,m)}},async getOrders(r){return this.obtenerPedidos(r)},async actualizarEstadoPedido(r,t){if(l(r,"ID del pedido"),!t||typeof t!="string")throw new Error("El estado del pedido es requerido");try{const{data:e,error:o}=await i.from("orders").update({status:t}).eq("id",r).select().single();return o&&c(o,"Error actualizando estado del pedido"),e}catch(e){c(e,"Error actualizando estado del pedido")}},async updateOrderStatus(r,t){return this.actualizarEstadoPedido(r,t)}},f=12e4,_=15e3,S=w((r,t)=>({store:null,stats:null,orders:[],products:[],customers:[],isLoadingStore:!1,isLoadingStats:!1,isLoadingOrders:!1,isLoadingProducts:!1,isLoadingCustomers:!1,error:null,lastFetch:{stats:0,orders:0,products:0,customers:0},setStore:e=>r({store:e}),updateStoreSettings:async e=>{const o=t().store;if(o)try{const a=await d.actualizarTienda(o.id,e);return r({store:a}),a}catch(a){throw a}},fetchCustomers:async e=>{if(!e)return;const o=Date.now();if(!(o-t().lastFetch.customers<3e5&&t().customers.length>0)){r({isLoadingCustomers:!0});try{const a=await d.obtenerClientesTienda(e);r(s=>({customers:a,lastFetch:{...s.lastFetch,customers:o}}))}catch(a){console.error(a)}finally{r({isLoadingCustomers:!1})}}},clearError:()=>r({error:null}),fetchStoreData:async e=>{if(!e){console.warn("[useStoreDashboard] fetchStoreData: userId requerido");return}const o=t().store;if(o&&o.owner_id===e)return;r({isLoadingStore:!0,error:null});const a=setTimeout(()=>{t().isLoadingStore&&r({isLoadingStore:!1,error:"Tiempo de espera agotado. Por favor recarga la página."})},_);try{const s=await d.obtenerTiendaPorPropietario(e);clearTimeout(a),r({store:s}),s&&t().fetchStats(s.id)}catch(s){console.error("[useStoreDashboard] Error cargando tienda:",s),clearTimeout(a),r({error:"No se pudo cargar la información del negocio."})}finally{r({isLoadingStore:!1})}},fetchStats:async(e,o=!1)=>{if(!e)return;const a=Date.now(),s=t().lastFetch.stats;if(!(!o&&a-s<f&&t().stats)){r({isLoadingStats:!0});try{const[n,u]=await Promise.all([d.obtenerEstadisticasTienda(e).catch(()=>({})),d.obtenerIngresosMensuales(e).catch(()=>[])]);r(g=>({stats:{...n,monthlyIncome:u},lastFetch:{...g.lastFetch,stats:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando estadísticas:",n)}finally{r({isLoadingStats:!1})}}},fetchOrders:async(e,o=!1)=>{if(!e)return;const a=Date.now(),s=t().lastFetch.orders;if(!(!o&&a-s<f&&t().orders.length>0)){r({isLoadingOrders:!0});try{const n=await d.obtenerPedidos(e);r(u=>({orders:n,lastFetch:{...u.lastFetch,orders:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando pedidos:",n)}finally{r({isLoadingOrders:!1})}}},fetchProducts:async(e,o=!1)=>{if(!e)return;const a=Date.now(),s=t().lastFetch.products;if(!(!o&&a-s<f&&t().products.length>0)){r({isLoadingProducts:!0});try{const n=await d.obtenerProductos(e);r(u=>({products:n,lastFetch:{...u.lastFetch,products:a}}))}catch(n){console.error("[useStoreDashboard] Error cargando productos:",n)}finally{r({isLoadingProducts:!1})}}},updateOrderStatus:async(e,o)=>{if(!e||!o)throw new Error("ID del pedido y estado son requeridos");try{await d.actualizarEstadoPedido(e,o),r(a=>({orders:a.orders.map(s=>s.id===e?{...s,status:o}:s)}))}catch(a){throw console.error("[useStoreDashboard] Error actualizando pedido:",a),a}},addProduct:async e=>{if(!e)throw new Error("Datos del producto son requeridos");try{const o=await d.crearProducto(e);return r(a=>{var s;return{products:[o,...a.products],stats:a.stats?{...a.stats,total_products:Number(((s=a.stats)==null?void 0:s.total_products)||0)+1}:a.stats}}),o}catch(o){throw console.error("[useStoreDashboard] Error creando producto:",o),o}},updateProduct:async(e,o)=>{if(!e||!o)throw new Error("ID del producto y actualizaciones son requeridos");try{const a=await d.actualizarProducto(e,o);return r(s=>({products:s.products.map(n=>n.id===e?{...n,...a}:n)})),a}catch(a){throw console.error("[useStoreDashboard] Error actualizando producto:",a),a}},deleteProduct:async e=>{if(!e)throw new Error("ID del producto es requerido");try{await d.eliminarProducto(e),r(o=>{var a;return{products:o.products.filter(s=>s.id!==e),stats:o.stats?{...o.stats,total_products:Math.max(0,Number(((a=o.stats)==null?void 0:a.total_products)||0)-1)}:o.stats}})}catch(o){throw console.error("[useStoreDashboard] Error eliminando producto:",o),o}},invalidateCache:()=>{r({lastFetch:{stats:0,orders:0,products:0}})},reset:()=>{r({store:null,stats:null,orders:[],products:[],isLoadingStore:!1,isLoadingStats:!1,isLoadingOrders:!1,isLoadingProducts:!1,error:null,lastFetch:{stats:0,orders:0,products:0}})}}));export{S as default,S as useStoreDashboard};
