import{f as Z,e as f,v as J,r as p,j as e,B as w,P as Q,b as W,T as X,t as y,c as Y}from"./index-4020e339.js";import{L as ee,B as ae}from"./BaseStoreDashboard-0e39fc73.js";import se from"./OverviewTab-30ffe364.js";import{C as re,c as te}from"./card-cc9cfd5e.js";import{I as x}from"./input-72252c3d.js";import{S as A,a as B,b as U,c as q,d}from"./select-31cdb233.js";import{D as ie,f as oe,a as le,b as ne,c as ce}from"./dialog-d2829896.js";import{L as h}from"./label-dfea19c8.js";import{T as de}from"./textarea-6e954f6a.js";import{useStoreDashboard as me}from"./useStoreDashboard-092a1cc0.js";import{S as k}from"./sprout-96a24ec4.js";import{S as pe}from"./search-90c48c54.js";import{P as ue}from"./pencil-5a5480e6.js";import he from"./OrdersTab-e6190215.js";import{BulkUploadTab as ge}from"./BulkUploadTab-c21a8eac.js";import xe from"./FinancialsTab-ae36bb23.js";import fe from"./AdminTab-a5eee867.js";import{S as je,a as be}from"./StoreCustomersTab-f7a15481.js";import{U as O}from"./users-dec98a74.js";import{U as ve}from"./upload-c1efbb4a.js";import{D as ye,S as we}from"./settings-3a739b87.js";import"./Helmet-966781f7.js";import"./log-out-30241d86.js";import"./index-a6eb7b0d.js";import"./triangle-alert-30e3235d.js";import"./package-1cc03608.js";import"./trending-up-36728e9d.js";import"./check-8b5d22b0.js";import"./badge-54788017.js";import"./clock-f4d06a64.js";import"./truck-45a9dcb6.js";import"./map-pin-865d1b33.js";import"./circle-alert-dc75c245.js";import"./credit-card-bea94bde.js";import"./user-plus-36b776d9.js";/**
 * @license lucide-react v0.561.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}],["path",{d:"M15.947 12.65a4 4 0 0 0-5.925-4.128",key:"dpwdj0"}],["path",{d:"M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z",key:"s09mg5"}]],Ne=Z("cloud-sun",Ce),S={async getCrops(a){const{data:l,error:r}=await f.from("products").select("*").eq("store_id",a).order("created_at",{ascending:!1});if(r)throw r;return l.map(i=>({...i}))},async saveCrop(a){if(a.id){const{data:l,error:r}=await f.from("products").update(a).eq("id",a.id).select().single();if(r)throw r;return l}else{const{data:l,error:r}=await f.from("products").insert(a).select().single();if(r)throw r;return l}},async deleteCrop(a){const{error:l}=await f.from("products").delete().eq("id",a);if(l)throw l}},Se=J((a,l)=>({crops:[],isLoadingCrops:!1,error:null,fetchCrops:async r=>{a({isLoadingCrops:!0,error:null});try{const i=await S.getCrops(r);a({crops:i})}catch(i){a({error:i.message})}finally{a({isLoadingCrops:!1})}},addCrop:async r=>{try{const i=await S.saveCrop(r);return a(c=>({crops:[i,...c.crops]})),i}catch(i){throw i}},updateCrop:async(r,i)=>{try{const c=await S.saveCrop({id:r,...i});return a(j=>({crops:j.crops.map(t=>t.id===r?c:t)})),c}catch(c){throw c}},deleteCrop:async r=>{try{await S.deleteCrop(r),a(i=>({crops:i.crops.filter(c=>c.id!==r)}))}catch(i){throw i}}})),ke=({product:a,onEdit:l,onDelete:r})=>{var c,j;const i=a.sku||((j=(c=a.description)==null?void 0:c.match(/Lote:\s*([^\n]+)/))==null?void 0:j[1])||"Sin Lote";return e.jsxs(re,{className:"rounded-2xl overflow-hidden border border-green-100 shadow-sm hover:shadow-lg transition-all group bg-white h-full flex flex-col",children:[e.jsxs("div",{className:"relative h-48 bg-green-50 p-4 flex items-center justify-center",children:[a.image_url?e.jsx("img",{src:a.image_url,alt:a.name,className:"max-h-full max-w-full object-cover rounded-lg"}):e.jsxs("div",{className:"flex flex-col items-center text-green-300",children:[e.jsx(k,{className:"h-12 w-12 mb-2"}),e.jsx("span",{className:"text-xs font-semibold",children:"Sin foto"})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20",children:[e.jsx(w,{variant:"secondary",size:"icon",className:"h-8 w-8 rounded-full shadow-md bg-white hover:bg-green-50",onClick:t=>{t.stopPropagation(),l(a)},children:e.jsx(ue,{className:"h-4 w-4 text-green-700"})}),e.jsx(w,{variant:"destructive",size:"icon",className:"h-8 w-8 rounded-full shadow-md",onClick:t=>{t.stopPropagation(),r(a.id)},children:e.jsx(X,{className:"h-4 w-4"})})]})]}),e.jsxs(te,{className:"p-4 flex-1 flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-between items-start mb-1",children:e.jsx("h3",{className:"font-bold text-slate-900 line-clamp-2 text-lg leading-tight",children:a.name})}),e.jsx("p",{className:"text-xs text-green-600 font-medium mb-1 uppercase tracking-wide",children:a.category||"General"}),e.jsxs("p",{className:"text-xs text-gray-400 mb-2",children:["Lote: ",i]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2 pt-2 border-t border-green-50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Precio / Kg"}),e.jsxs("span",{className:"text-lg font-bold text-slate-900",children:["$",Number(a.price).toLocaleString()]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Disponible"}),e.jsxs("span",{className:"text-sm font-semibold text-green-700",children:[a.stock," Kg"]})]})]})]})]})},Pe=()=>{const{crops:a,fetchCrops:l,addCrop:r,updateCrop:i,deleteCrop:c,isLoadingCrops:j}=Se(),{store:t}=me();p.useState("grid");const[L,G]=p.useState(""),[M,C]=p.useState(!1),[F,E]=p.useState(!1),[N,P]=p.useState(null),[o,b]=p.useState({name:"",price:"",description:"",stock:"1",category:"Verduras",sku:"",image_url:""}),[T,D]=p.useState(null);p.useEffect(()=>{t!=null&&t.id&&l(t.id)},[t==null?void 0:t.id,l]);const I=a.filter(s=>s.name.toLowerCase().includes(L.toLowerCase())),V=()=>{P(null),b({name:"",price:"",description:"",stock:"100",category:"Verduras",sku:"",image_url:""}),D(null),C(!0)},$=s=>{var m,g;P(s);const n=s.sku||((g=(m=s.description)==null?void 0:m.match(/Lote:\s*([^\n]+)/))==null?void 0:g[1])||"",u=s.description?s.description.replace(/\n\nLote:\s*[^\n]+/,""):"";b({name:s.name,price:s.price,description:u,stock:s.stock,category:s.category||"Verduras",sku:n,image_url:s.image_url||""}),D(null),C(!0)},v=s=>{const{name:n,value:u}=s.target;b(m=>({...m,[n]:u}))},z=s=>{s.target.files&&s.target.files[0]&&D(s.target.files[0])},H=async(s,n,u)=>{const{error:m,data:g}=await f.storage.from(n).upload(u,s);if(m)throw new Error(`Error al subir imagen: ${m.message}`);const{data:_}=f.storage.from(n).getPublicUrl(g.path);return _.publicUrl},R=async s=>{s.preventDefault(),E(!0);try{let n=o.image_url;if(T&&(t!=null&&t.id)){const g=T.name.replace(/[^a-zA-Z0-9.]/g,"_"),_=`${t.id}/${Date.now()}_agri_${g}`;n=await H(T,"product-images",_)}const u=o.sku?`${o.description||""}

Lote: ${o.sku}`:o.description,m={name:o.name,price:parseFloat(o.price),stock:parseInt(o.stock),product_type:"physical",requires_shipping:!0,image_url:n,description:u,category:o.category,sku:o.sku,store_id:t==null?void 0:t.id};N?(await i(N.id,m),y({title:"Cosecha actualizada",description:"Información guardada exitosamente."})):(await r(m),y({title:"Cosecha registrada",description:"Disponible para venta."})),C(!1),P(null),b({name:"",price:"",description:"",stock:"100",category:"Verduras",sku:"",image_url:""})}catch(n){console.error(n),y({title:"Error",description:"No se pudo guardar la información.",variant:"destructive"})}finally{E(!1)}},K=async s=>{if(window.confirm("¿Confirmas retirar esta cosecha del inventario?"))try{await c(s),y({title:"Cosecha retirada"})}catch{y({title:"Error",description:"No se pudo eliminar.",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-green-50 border border-green-100 p-6 rounded-2xl",children:[e.jsxs("h1",{className:"text-3xl font-extrabold text-green-900 flex items-center gap-3",children:[e.jsx(k,{className:"h-8 w-8 text-green-600"}),"Gestión de Cosechas"]}),e.jsx("p",{className:"text-green-700 mt-2",children:"Registra tus cultivos disponibles, asigna lotes y gestiona tu inventario agrícola."})]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-2 rounded-2xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"relative w-full md:w-96",children:[e.jsx(pe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(x,{placeholder:"Buscar cultivo o lote...",className:"pl-10 bg-gray-50 border-transparent focus:bg-white transition-colors",value:L,onChange:s=>G(s.target.value)})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsxs(A,{defaultValue:"all",onValueChange:s=>console.log(s),children:[e.jsx(B,{className:"w-[150px] rounded-full bg-gray-50 border-transparent",children:e.jsx(U,{placeholder:"Tipo de Cultivo"})}),e.jsxs(q,{children:[e.jsx(d,{value:"all",children:"Todos"}),e.jsx(d,{value:"Frutas",children:"Frutas"}),e.jsx(d,{value:"Verduras",children:"Verduras"}),e.jsx(d,{value:"Granos",children:"Granos"}),e.jsx(d,{value:"Tuberculos",children:"Tubérculos"})]})]}),e.jsxs(ie,{open:M,onOpenChange:C,children:[e.jsx(oe,{asChild:!0,children:e.jsxs(w,{className:"bg-green-600 text-white hover:bg-green-700 rounded-full px-6 shadow-green-200 shadow-lg",onClick:V,children:[e.jsx(Q,{className:"h-4 w-4 mr-2"})," Nueva Cosecha"]})}),e.jsxs(le,{className:"sm:max-w-[500px]",children:[e.jsx(ne,{children:e.jsx(ce,{className:"text-green-900",children:N?"Editar Cosecha":"Registrar Nueva Cosecha"})}),e.jsxs("form",{onSubmit:R,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"name",children:"Producto / Cultivo"}),e.jsx(x,{id:"name",name:"name",required:!0,value:o.name,onChange:v,placeholder:"Ej: Papa Capira, Tomate Chonto"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"price",children:"Precio por Kg/Unidad"}),e.jsx(x,{id:"price",name:"price",type:"number",required:!0,value:o.price,onChange:v,placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"stock",children:"Cantidad Disponible (Kg)"}),e.jsx(x,{id:"stock",name:"stock",type:"number",required:!0,value:o.stock,onChange:v})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"category",children:"Tipo de Cultivo"}),e.jsxs(A,{name:"category",value:o.category,onValueChange:s=>b(n=>({...n,category:s})),children:[e.jsx(B,{children:e.jsx(U,{placeholder:"Seleccione..."})}),e.jsxs(q,{children:[e.jsx(d,{value:"Frutas",children:"Frutas"}),e.jsx(d,{value:"Verduras",children:"Verduras"}),e.jsx(d,{value:"Granos",children:"Granos"}),e.jsx(d,{value:"Tuberculos",children:"Tubérculos"}),e.jsx(d,{value:"Hierbas",children:"Hierbas / Aromáticas"}),e.jsx(d,{value:"Otro",children:"Otro"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"sku",children:"Lote / Variedad (Opcional)"}),e.jsx(x,{id:"sku",name:"sku",value:o.sku,onChange:v,placeholder:"Ej: Lote A-2024"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"image_upload",children:"Foto del Cultivo"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[o.image_url&&e.jsx("img",{src:o.image_url,alt:"Preview",className:"h-10 w-10 object-cover rounded border"}),e.jsx(x,{id:"image_upload",type:"file",accept:"image/*",onChange:z})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"description",children:"Descripción Adicional"}),e.jsx(de,{id:"description",name:"description",value:o.description,onChange:v,rows:3,placeholder:"Detalles sobre la calidad, fecha de cosecha, etc."})]}),e.jsx(w,{type:"submit",className:"w-full bg-green-600 text-white hover:bg-green-700 font-bold",disabled:F,children:F?e.jsx(W,{className:"h-4 w-4 animate-spin"}):N?"Guardar Cambios":"Registrar Cosecha"})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6",children:[I.map(s=>e.jsx("div",{className:"relative group h-full",children:e.jsx(ke,{product:{...s,discount:0},onEdit:$,onDelete:K})},s.id)),I.length===0&&e.jsxs("div",{className:"col-span-full py-12 text-center bg-gray-50 rounded-xl border-dashed border-2 border-gray-200",children:[e.jsx(k,{className:"h-12 w-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"No has registrado ninguna cosecha aún."}),e.jsx(w,{variant:"link",onClick:V,className:"text-green-600",children:"Registrar mi primera cosecha"})]})]})]})},ca=p.memo(({store:a})=>{const l=[{path:"",label:"Admin Finca",icon:ee,element:e.jsx(se,{storeId:a.id})},{path:"cosechas",label:"Cosechas",icon:k,element:e.jsx(Pe,{})},{path:"pedidos",label:"Pedidos",icon:Y,element:e.jsx(he,{storeId:a.id})},{path:"clientes",label:"Clientes",icon:O,element:e.jsx(je,{})},{path:"importar",label:"Importar",icon:ve,element:e.jsx(ge,{storeId:a.id,onProductsUploaded:()=>{}})},{path:"clima",label:"Clima",icon:Ne,element:e.jsx("div",{className:"p-8 text-center text-muted-foreground",children:"Módulo de clima en desarrollo..."})},{path:"finanzas",label:"Balance",icon:ye,element:e.jsx(xe,{storeId:a.id})},{path:"equipo",label:"Trabajadores",icon:O,element:e.jsx(fe,{storeId:a.id})},{path:"configuracion",label:"Configuración",icon:we,element:e.jsx(be,{})}];return e.jsx(ae,{store:a,tabs:l})});export{ca as default};
