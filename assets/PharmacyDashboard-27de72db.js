import{k as f,Q as E,r as u,j as e,B as v,P as I,D as _,v as B,z as F,E as R,f as U,C as O,c as V,T as $,t as D,g as z}from"./index-d21c7dd6.js";import{L as G,B as H}from"./BaseStoreDashboard-111ddf03.js";import J from"./OverviewTab-be96e9e2.js";import{I as h}from"./input-556f8b0d.js";import{S as K,a as Q,b as W,c as X,d as b}from"./select-8e0764e3.js";import{L as m}from"./label-c93a7708.js";import{T as Y}from"./textarea-114b504e.js";import{S as Z}from"./switch-fc7bb2dd.js";import{B as ee}from"./badge-2866762f.js";import{useStoreDashboard as ae}from"./useStoreDashboard-3f2e18e7.js";import{P}from"./pill-87879483.js";import{P as re}from"./pencil-579dc242.js";import se from"./OrdersTab-aa87129b.js";import{BulkUploadTab as te}from"./BulkUploadTab-1ae8830a.js";import ie from"./FinancialsTab-9a6b387b.js";import oe from"./AdminTab-854e3c47.js";import{S as ne,a as ce}from"./StoreCustomersTab-0b339e64.js";import{U as k}from"./users-d9e090c9.js";import{U as le}from"./upload-15114de0.js";import{D as de,S as me}from"./settings-90173959.js";import"./Helmet-ad85e013.js";import"./log-out-5798deb2.js";import"./index-494375a5.js";import"./triangle-alert-5923b5ba.js";import"./package-88130c4d.js";import"./trending-up-5882c34b.js";import"./check-96b5806b.js";import"./index-8e9e509f.js";import"./clock-62db4e3a.js";import"./truck-29f746c0.js";import"./map-pin-6c6743d0.js";import"./circle-alert-35788dc1.js";import"./credit-card-f2402ef9.js";import"./user-plus-e3f79c3c.js";const N={_parseMetadata(a){var c;if(!a)return a;let o={expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""};const n=(c=a.description)==null?void 0:c.match(/PHARMA_META:\s*({.*})/s);let s=a.description||"";if(n)try{o={...o,...JSON.parse(n[1])},s=a.description.replace(/\n\nPHARMA_META:\s*{.*}/s,"")}catch{}return{...a,meta:o,description:s,full_description:a.description}},async getPharmacyProducts(a){const{data:o,error:n}=await f.from("products").select("*").eq("store_id",a).order("created_at",{ascending:!1});if(n)throw n;return o.map(this._parseMetadata)},async savePharmacyProduct(a){const{meta:o,description:n,...s}=a,c=JSON.stringify(o),i=`${n||""}

PHARMA_META: ${c}`,l={...s,description:i};if(l.id){const{data:j,error:p}=await f.from("products").update(l).eq("id",l.id).select().single();if(p)throw p;return this._parseMetadata(j)}else{const{data:j,error:p}=await f.from("products").insert(l).select().single();if(p)throw p;return this._parseMetadata(j)}},async deletePharmacyProduct(a){const{error:o}=await f.from("products").delete().eq("id",a);if(o)throw o}},pe=E((a,o)=>({products:[],isLoading:!1,error:null,fetchProducts:async n=>{a({isLoading:!0,error:null});try{const s=await N.getPharmacyProducts(n);a({products:s})}catch(s){a({error:s.message})}finally{a({isLoading:!1})}},saveProduct:async n=>{try{const s=await N.savePharmacyProduct(n);return a(c=>c.products.find(l=>l.id===s.id)?{products:c.products.map(l=>l.id===s.id?s:l)}:{products:[s,...c.products]}),s}catch(s){throw s}},deleteProduct:async n=>{try{await N.deletePharmacyProduct(n),a(s=>({products:s.products.filter(c=>c.id!==n)}))}catch(s){throw s}}})),ue=({product:a,onEdit:o,onDelete:n})=>{const s=a.meta||{},c=s.expirationDate?Math.ceil((new Date(s.expirationDate)-new Date)/(1e3*60*60*24)):999,i=c<0,l=c<90&&!i;return e.jsxs(O,{className:"rounded-xl overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all group bg-white h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 flex items-start justify-between bg-slate-50 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg text-blue-600",children:e.jsx(P,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-900 leading-tight",children:a.name}),e.jsx("p",{className:"text-xs text-slate-500",children:s.laboratory||"Laboratorio Genérico"})]})]}),s.requiresPrescription&&e.jsx(ee,{variant:"outline",className:"text-red-600 border-red-200 bg-red-50 text-[10px]",children:"Rx"})]}),e.jsxs(V,{className:"p-4 flex-1 flex flex-col gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"bg-gray-50 p-2 rounded border border-gray-100",children:[e.jsx("span",{className:"text-gray-400 block mb-1",children:"Lote"}),e.jsx("span",{className:"font-mono text-slate-700",children:s.batchNumber||"N/A"})]}),e.jsxs("div",{className:`p-2 rounded border ${i?"bg-red-50 border-red-200":l?"bg-orange-50 border-orange-200":"bg-green-50 border-green-200"}`,children:[e.jsx("span",{className:`block mb-1 ${i?"text-red-400":"text-gray-400"}`,children:"Vence"}),e.jsx("span",{className:`font-bold ${i?"text-red-700":"text-slate-700"}`,children:s.expirationDate||"N/A"})]})]}),e.jsxs("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-lg font-bold text-blue-900",children:["$",Number(a.price).toLocaleString()]}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Stock: ",a.stock]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-blue-600",onClick:()=>o(a),children:e.jsx(re,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"h-8 w-8 text-slate-400 hover:text-red-600",onClick:()=>n(a.id),children:e.jsx($,{className:"h-4 w-4"})})]})]})]})]})},he=()=>{const{products:a,fetchProducts:o,saveProduct:n,deleteProduct:s,isLoading:c}=pe(),{store:i}=ae(),[l,j]=u.useState(""),[p,g]=u.useState(!1),[w,C]=u.useState(!1),[y,S]=u.useState(null),[t,d]=u.useState({name:"",price:"",stock:"1",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""});u.useEffect(()=>{i!=null&&i.id&&o(i.id)},[i==null?void 0:i.id,o]);const M=a.filter(r=>r.name.toLowerCase().includes(l.toLowerCase())),T=()=>{S(null),d({name:"",price:"",stock:"10",description:"",expirationDate:"",batchNumber:"",requiresPrescription:!1,presentation:"Caja",laboratory:""}),g(!0)},q=r=>{S(r);const x=r.meta||{};d({name:r.name,price:r.price,stock:r.stock,description:r.description||"",...x}),g(!0)},A=async r=>{r.preventDefault(),C(!0);try{const x={id:y?y.id:void 0,name:t.name,price:parseFloat(t.price),stock:parseInt(t.stock),product_type:"physical",requires_shipping:!0,description:t.description,category:"Farmacia",store_id:i==null?void 0:i.id,meta:{expirationDate:t.expirationDate,batchNumber:t.batchNumber,requiresPrescription:t.requiresPrescription,presentation:t.presentation,laboratory:t.laboratory}};await n(x),D({title:y?"Medicamento actualizado":"Medicamento registrado"}),g(!1)}catch(x){console.error(x),D({title:"Error",variant:"destructive"})}finally{C(!1)}},L=async r=>{window.confirm("¿Retirar medicamento?")&&await s(r)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-100 p-6 rounded-2xl flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-blue-900 flex items-center gap-2",children:[e.jsx(P,{className:"h-8 w-8 text-blue-600"}),"Inventario Farmacéutico"]}),e.jsx("p",{className:"text-blue-700 mt-1",children:"Control de vencimientos, lotes y regencia."})]}),e.jsxs(v,{className:"bg-blue-600 hover:bg-blue-700 rounded-full",onClick:T,children:[e.jsx(I,{className:"h-4 w-4 mr-2"})," Nuevo Medicamento"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:M.map(r=>e.jsx(ue,{product:{...r,discount:0},onEdit:q,onDelete:L},r.id))}),e.jsx(_,{open:p,onOpenChange:g,children:e.jsxs(B,{className:"sm:max-w-[600px] max-h-[90vh] overflow-y-auto",children:[e.jsx(F,{children:e.jsx(R,{children:"Gestión de Medicamento"})}),e.jsxs("form",{onSubmit:A,className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(m,{children:"Nombre Comercial / Genérico"}),e.jsx(h,{value:t.name,onChange:r=>d({...t,name:r.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Laboratorio"}),e.jsx(h,{value:t.laboratory,onChange:r=>d({...t,laboratory:r.target.value}),placeholder:"Ej: Bayer, MK"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Presentación"}),e.jsxs(K,{value:t.presentation,onValueChange:r=>d({...t,presentation:r}),children:[e.jsx(Q,{children:e.jsx(W,{})}),e.jsxs(X,{children:[e.jsx(b,{value:"Caja",children:"Caja"}),e.jsx(b,{value:"Frasco",children:"Frasco"}),e.jsx(b,{value:"Tableta",children:"Tableta"}),e.jsx(b,{value:"Ampolla",children:"Ampolla"}),e.jsx(b,{value:"Unidad",children:"Unidad"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Lote"}),e.jsx(h,{value:t.batchNumber,onChange:r=>d({...t,batchNumber:r.target.value}),placeholder:"B-123456"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Fecha Vencimiento"}),e.jsx(h,{type:"date",value:t.expirationDate,onChange:r=>d({...t,expirationDate:r.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Precio Venta"}),e.jsx(h,{type:"number",value:t.price,onChange:r=>d({...t,price:r.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Stock Disponible"}),e.jsx(h,{type:"number",value:t.stock,onChange:r=>d({...t,stock:r.target.value}),required:!0})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 p-3 rounded border border-red-100",children:[e.jsx(m,{className:"text-red-800",children:"¿Requiere Fórmula Médica?"}),e.jsx(Z,{checked:t.requiresPrescription,onCheckedChange:r=>d({...t,requiresPrescription:r})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Indicaciones / Descripción"}),e.jsx(Y,{value:t.description,onChange:r=>d({...t,description:r.target.value})})]}),e.jsx(v,{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700",disabled:w,children:w?e.jsx(U,{className:"animate-spin"}):"Guardar Medicamento"})]})]})})]})},Qe=u.memo(({store:a})=>{const o=[{path:"",label:"Resumen",icon:G,element:e.jsx(J,{storeId:a.id})},{path:"inventario",label:"Medicamentos",icon:P,element:e.jsx(he,{})},{path:"pedidos",label:"Pedidos",icon:z,element:e.jsx(se,{storeId:a.id})},{path:"clientes",label:"Pacientes",icon:k,element:e.jsx(ne,{})},{path:"importar",label:"Importar",icon:le,element:e.jsx(te,{storeId:a.id,onProductsUploaded:()=>{}})},{path:"finanzas",label:"Caja",icon:de,element:e.jsx(ie,{storeId:a.id})},{path:"equipo",label:"Farmacéuticos",icon:k,element:e.jsx(oe,{storeId:a.id})},{path:"configuracion",label:"Configuración",icon:me,element:e.jsx(ce,{})}];return e.jsx(H,{store:a,tabs:o})});export{Qe as default};
